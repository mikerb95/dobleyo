---
import AnimatedHeader from './AnimatedHeader.jsx';
---

<AnimatedHeader client:load />

<script>
  // L√≥gica del Header (Granos y Men√∫)
  (function initNavBeans() {
    const header = document.querySelector(".header-animated");
    if (!header) return;
    
    // Crear el contenedor de granos si no existe
    let layer = document.querySelector(".nav-beans");
    if (!layer) {
      layer = document.createElement("div");
      layer.className = "nav-beans";
      layer.setAttribute("aria-hidden", "true");
      header.insertBefore(layer, header.firstChild);
    }

    const beanSrc = "/assets/branding/coffebeannav.png";
    const beans = [];
    const COUNT = 68;
    for (let i = 0; i < COUNT; i++) {
      const img = document.createElement("img");
      img.className = "bean";
      img.src = beanSrc;
      const xPct = 4 + Math.random() * 92;
      const yPct = 8 + Math.random() * 84;
      const rot = -40 + Math.random() * 80;
      const scale = 0.8 + Math.random() * 0.6;
      const size = 16 + Math.random() * 16 + (Math.random() < 0.15 ? 8 : 0);
      img.style.left = xPct + "%";
      img.style.top = yPct + "%";
      img.style.setProperty("--rot", rot + "deg");
      img.style.setProperty("--s", scale.toString());
      img.style.setProperty("--bean-size", size + "px");
      img._xPct = xPct / 100;
      img._yPct = yPct / 100;
      img._rand = Math.random();
      layer.appendChild(img);
      beans.push(img);
    }

    const pointer = { x: 0, y: 0, active: false };
    let rafId = 0;
    function animate() {
      if (pointer.active) {
        const rect = layer.getBoundingClientRect();
        const cx = pointer.x - rect.left;
        const cy = pointer.y - rect.top;
        for (const b of beans) {
          const bx = (b._xPct || 0.5) * rect.width;
          const by = (b._yPct || 0.5) * rect.height;
          const dx0 = bx - cx;
          const dy0 = by - cy;
          const d = Math.hypot(dx0, dy0) || 0.0001;
          const radius = 140;
          const strength = 26 + (b._rand || 0) * 22;
          const falloff = Math.max(0, radius - d) / radius;
          const repel = falloff * strength;
          const nx = dx0 / d;
          const ny = dy0 / d;
          const dx = nx * repel;
          const dy = ny * repel;
          b.style.setProperty("--dx", dx.toFixed(2) + "px");
          b.style.setProperty("--dy", dy.toFixed(2) + "px");
        }
      }
      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);

    header.addEventListener("mouseenter", () => {
      pointer.active = true;
      header.classList.add("beans-active");
    });
    header.addEventListener("mousemove", (e) => {
      pointer.x = e.clientX;
      pointer.y = e.clientY;
    });
    header.addEventListener("mouseleave", () => {
      pointer.active = false;
      header.classList.remove("beans-active");
      beans.forEach((b) => {
        b.style.setProperty("--dx", "0px");
        b.style.setProperty("--dy", "0px");
      });
    });
  })();

  // Verificar sesi√≥n y actualizar bot√≥n de usuario
  (async function checkAuthStatus() {
    try {
      const res = await fetch("/api/auth/me", {
        credentials: "include",
      });

      const userBtn = document.getElementById("userNavBtn");
      const userMobileBtn = document.getElementById("userNavMobileBtn");

      if (res.ok) {
        // Usuario logueado
        if (userBtn) {
          userBtn.href = "/cuenta";
          userBtn.setAttribute("aria-label", "Mi cuenta");
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/cuenta";
          userMobileBtn.setAttribute("aria-label", "Mi cuenta");
        }
      } else {
        // Usuario no logueado
        if (userBtn) {
          userBtn.href = "/login";
          userBtn.setAttribute("aria-label", "Iniciar sesi√≥n");
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/login";
          userMobileBtn.setAttribute("aria-label", "Iniciar sesi√≥n");
        }
      }
    } catch (err) {
      // Error en la verificaci√≥n, asumir no logueado
      const userBtn = document.getElementById("userNavBtn");
      const userMobileBtn = document.getElementById("userNavMobileBtn");
      if (userBtn) {
        userBtn.href = "/login";
      }
      if (userMobileBtn) {
        userMobileBtn.href = "/login";
      }
    }
  })();
</script>

<style>
  .nav-beans {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .bean {
    position: absolute;
    width: var(--bean-size, 20px);
    height: auto;
    transform: rotate(var(--rot, 0deg)) scale(var(--s, 1));
    transition: transform 0.1s ease-out;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    translate: var(--dx, 0px) var(--dy, 0px);
  }

  .bean:not(.visible) {
    opacity: 0.3;
  }

  .beans-active .bean {
    transition: translate 0.1s ease-out;
  }
</style>
    <div class="nav-beans" aria-hidden="true"></div>
    <a class="brand" href="/" data-link>
      <img src="/assets/logo.png" alt="DobleYo" height="56" />
    </a>
    <nav class="nav">
      <a href="/" data-link>Inicio</a>
      <a href="/tienda" data-link>Tienda</a>
      <a href="/blog" data-link>Blog</a>
      <a href="/trazabilidad" data-link>Trazabilidad</a>
    </nav>
    <div class="actions">
      <button
        id="themeToggle"
        class="theme-toggle"
        aria-label="Cambiar tema"
        title="Cambiar tema">üåô</button
      >
      <a href="/carrito" class="icon-btn" data-link
        >üõí<span class="badge" id="cartCount">0</span></a
      >
      <a
        href="/login"
        class="icon-btn user-btn"
        aria-label="Iniciar sesi√≥n"
        data-link
        id="userNavBtn"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          ><path
            d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"
            fill="currentColor"></path></svg
        >
      </a>
      <button id="menuBtn" class="hamburger" aria-label="Men√∫">‚ò∞</button>
    </div>
  </div>
  <div class="mobile-menu" id="mobileMenu" hidden>
    <a href="/" data-link>Inicio</a>
    <a href="/tienda" data-link>Tienda</a>
    <a href="/blog" data-link>Blog</a>
    <a href="/trazabilidad" data-link>Trazabilidad</a>
    <a
      href="/login"
      class="icon-btn user-btn"
      aria-label="Iniciar sesi√≥n"
      data-link
      id="userNavMobileBtn"
    >
      <svg
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        ><path
          d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"
          fill="currentColor"></path></svg
      >
    </a>
  </div>
</header>

<script>
  // L√≥gica del Header (Granos y Men√∫)
  (function initNavBeans() {
    const header = document.querySelector(".site-header");
    const layer = document.querySelector(".nav-beans");
    if (!header || !layer) return;
    const beanSrc = "/assets/branding/coffebeannav.png"; // Ruta absoluta desde public
    const beans = [];
    const COUNT = 68;
    for (let i = 0; i < COUNT; i++) {
      const img = document.createElement("img");
      img.className = "bean";
      img.src = beanSrc;
      const xPct = 4 + Math.random() * 92;
      const yPct = 8 + Math.random() * 84;
      const rot = -40 + Math.random() * 80;
      const scale = 0.8 + Math.random() * 0.6;
      const size = 16 + Math.random() * 16 + (Math.random() < 0.15 ? 8 : 0);
      img.style.left = xPct + "%";
      img.style.top = yPct + "%";
      img.style.setProperty("--rot", rot + "deg");
      img.style.setProperty("--s", scale.toString());
      img.style.setProperty("--bean-size", size + "px");
      // @ts-ignore
      img._xPct = xPct / 100;
      // @ts-ignore
      img._yPct = yPct / 100;
      // @ts-ignore
      img._rand = Math.random();
      layer.appendChild(img);
      beans.push(img);
    }

    const pointer = { x: 0, y: 0, active: false };
    let rafId = 0;
    function animate() {
      if (pointer.active) {
        const rect = layer.getBoundingClientRect();
        const cx = pointer.x - rect.left;
        const cy = pointer.y - rect.top;
        for (const b of beans) {
          // @ts-ignore
          const bx = (b._xPct || 0.5) * rect.width;
          // @ts-ignore
          const by = (b._yPct || 0.5) * rect.height;
          const dx0 = bx - cx;
          const dy0 = by - cy;
          const d = Math.hypot(dx0, dy0) || 0.0001;
          const radius = 140;
          // @ts-ignore
          const strength = 26 + (b._rand || 0) * 22;
          const falloff = Math.max(0, radius - d) / radius;
          const repel = falloff * strength;
          const nx = dx0 / d;
          const ny = dy0 / d;
          const dx = nx * repel;
          const dy = ny * repel;
          b.style.setProperty("--dx", dx.toFixed(2) + "px");
          b.style.setProperty("--dy", dy.toFixed(2) + "px");
        }
      }
      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);

    header.addEventListener("mouseenter", () => {
      pointer.active = true;
      header.classList.add("beans-active");
    });
    header.addEventListener("mousemove", (e) => {
      pointer.x = e.clientX;
      pointer.y = e.clientY;
    });
    header.addEventListener("mouseleave", () => {
      pointer.active = false;
      header.classList.remove("beans-active");
      beans.forEach((b) => {
        b.style.setProperty("--dx", "0px");
        b.style.setProperty("--dy", "0px");
      });
    });
  })();

  // Menu movil
  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  if (menuBtn && mobileMenu) {
    menuBtn.addEventListener("click", () => {
      const hidden = mobileMenu.hasAttribute("hidden");
      hidden
        ? mobileMenu.removeAttribute("hidden")
        : mobileMenu.setAttribute("hidden", "");
    });
  }

  // Verificar sesi√≥n y actualizar bot√≥n de usuario
  (async function checkAuthStatus() {
    try {
      const res = await fetch("/api/auth/me", {
        credentials: "include",
      });

      const userBtn = document.getElementById("userNavBtn");
      const userMobileBtn = document.getElementById("userNavMobileBtn");

      if (res.ok) {
        // Usuario logueado
        if (userBtn) {
          userBtn.href = "/cuenta";
          userBtn.setAttribute("aria-label", "Mi cuenta");
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/cuenta";
          userMobileBtn.setAttribute("aria-label", "Mi cuenta");
        }
      } else {
        // Usuario no logueado
        if (userBtn) {
          userBtn.href = "/login";
          userBtn.setAttribute("aria-label", "Iniciar sesi√≥n");
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/login";
          userMobileBtn.setAttribute("aria-label", "Iniciar sesi√≥n");
        }
      }
    } catch (err) {
      // Error en la verificaci√≥n, asumir no logueado
      const userBtn = document.getElementById("userNavBtn");
      const userMobileBtn = document.getElementById("userNavMobileBtn");
      if (userBtn) {
        userBtn.href = "/login";
      }
      if (userMobileBtn) {
        userMobileBtn.href = "/login";
      }
    }
  })();
</script>

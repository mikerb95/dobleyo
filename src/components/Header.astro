---

---

<header class="site-header" id="siteHeader">
  <div class="container">
    <div class="nav-beans" aria-hidden="true"></div>
    <a class="brand" href="/" data-link>
      <img src="/assets/logo.png" alt="DobleYo" height="56" />
    </a>
    <nav class="nav">
      <a href="/" data-link>Inicio</a>
      <a href="/tienda" data-link>Tienda</a>
      <a href="/blog" data-link>Blog</a>
      <a href="/trazabilidad" data-link>Trazabilidad</a>
      <a href="/envios-devoluciones" data-link>EnvÃ­os</a>
    </nav>
    <div class="actions">
      <a href="/carrito" class="icon-btn" data-link
        >ðŸ›’<span class="badge" id="cartCount">0</span></a
      >
      <div class="user-dropdown" id="userDropdown">
        <button
          class="icon-btn user-btn"
          aria-label="MenÃº de usuario"
          aria-haspopup="true"
          aria-expanded="false"
          id="userNavBtn"
        >
          <span
            id="userNameDisplay"
            style="display: none; margin-right: 0.5rem; font-size: 0.9rem; font-weight: 500;"
          ></span>
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            ><path
              d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"
              fill="currentColor"></path></svg
          >
        </button>
        <div class="dropdown-menu" id="userDropdownMenu">
          <a href="/cuenta" class="dropdown-item" data-link>Perfil</a>
          <a
            href="/app"
            class="dropdown-item"
            id="appsLink"
            data-link
            style="display: none;">Panel de apps</a
          >
          <a
            href="/app/productos"
            class="dropdown-item"
            id="productosLink"
            data-link
            style="display: none;">Productos</a
          >
          <a
            href="/app/auditoria"
            class="dropdown-item"
            id="auditLink"
            data-link
            style="display: none;">ðŸ“‹ AuditorÃ­a</a
          >
          <button class="dropdown-item" id="logoutBtn">Cerrar sesiÃ³n</button>
        </div>
      </div>
      <button id="menuBtn" class="hamburger" aria-label="MenÃº">â˜°</button>
    </div>
  </div>
  <div class="mobile-menu" id="mobileMenu" hidden>
    <a href="/" data-link>Inicio</a>
    <a href="/tienda" data-link>Tienda</a>
    <a href="/blog" data-link>Blog</a>
    <a href="/trazabilidad" data-link>Trazabilidad</a>
    <a href="/envios-devoluciones" data-link>EnvÃ­os y Devoluciones</a>
    <a
      href="/login"
      class="user-btn"
      aria-label="Iniciar sesiÃ³n"
      data-link
      id="userNavMobileBtn"
    >
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        ><path
          d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"
          fill="currentColor"></path></svg
      >
      <span id="userNameMobileDisplay" style="display: none;"></span>
      <span id="userMobileLabel">Mi Cuenta</span>
    </a>
  </div>
</header>

<script>
  // LÃ³gica del Header (Granos y MenÃº)
  (function initNavBeans() {
    const header = document.querySelector(".site-header");
    const layer = document.querySelector(".nav-beans");
    if (!header || !layer) return;
    const beanSrc = "/assets/branding/coffebeannav.png"; // Ruta absoluta desde public
    const beans = [];
    const COUNT = 68;
    for (let i = 0; i < COUNT; i++) {
      const img = document.createElement("img");
      img.className = "bean";
      img.src = beanSrc;
      const xPct = 4 + Math.random() * 92;
      const yPct = 8 + Math.random() * 84;
      const rot = -40 + Math.random() * 80;
      const scale = 0.8 + Math.random() * 0.6;
      const size = 16 + Math.random() * 16 + (Math.random() < 0.15 ? 8 : 0);
      img.style.left = xPct + "%";
      img.style.top = yPct + "%";
      img.style.setProperty("--rot", rot + "deg");
      img.style.setProperty("--s", scale.toString());
      img.style.setProperty("--bean-size", size + "px");
      // @ts-ignore
      img._xPct = xPct / 100;
      // @ts-ignore
      img._yPct = yPct / 100;
      // @ts-ignore
      img._rand = Math.random();
      layer.appendChild(img);
      beans.push(img);
    }

    const pointer = { x: 0, y: 0, active: false };
    let rafId = 0;
    function animate() {
      if (pointer.active) {
        const rect = layer.getBoundingClientRect();
        const cx = pointer.x - rect.left;
        const cy = pointer.y - rect.top;
        for (const b of beans) {
          // @ts-ignore
          const bx = (b._xPct || 0.5) * rect.width;
          // @ts-ignore
          const by = (b._yPct || 0.5) * rect.height;
          const dx0 = bx - cx;
          const dy0 = by - cy;
          const d = Math.hypot(dx0, dy0) || 0.0001;
          const radius = 140;
          // @ts-ignore
          const strength = 26 + (b._rand || 0) * 22;
          const falloff = Math.max(0, radius - d) / radius;
          const repel = falloff * strength;
          const nx = dx0 / d;
          const ny = dy0 / d;
          const dx = nx * repel;
          const dy = ny * repel;
          b.style.setProperty("--dx", dx.toFixed(2) + "px");
          b.style.setProperty("--dy", dy.toFixed(2) + "px");
        }
      }
      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);

    header.addEventListener("mouseenter", () => {
      pointer.active = true;
      header.classList.add("beans-active");
    });
    header.addEventListener("mousemove", (e) => {
      pointer.x = e.clientX;
      pointer.y = e.clientY;
    });
    header.addEventListener("mouseleave", () => {
      pointer.active = false;
      header.classList.remove("beans-active");
      beans.forEach((b) => {
        b.style.setProperty("--dx", "0px");
        b.style.setProperty("--dy", "0px");
      });
    });
  })();

  // Menu movil
  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");

  if (menuBtn && mobileMenu) {
    // Toggle del menÃº
    menuBtn.addEventListener("click", () => {
      const hidden = mobileMenu.hasAttribute("hidden");
      if (hidden) {
        mobileMenu.removeAttribute("hidden");
        menuBtn.classList.add("active");
        document.body.classList.add("menu-open");
      } else {
        mobileMenu.setAttribute("hidden", "");
        menuBtn.classList.remove("active");
        document.body.classList.remove("menu-open");
      }
    });

    // Cerrar menÃº al hacer click en un enlace
    mobileMenu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        mobileMenu.setAttribute("hidden", "");
        menuBtn.classList.remove("active");
        document.body.classList.remove("menu-open");
      });
    });

    // Cerrar menÃº al hacer click fuera
    document.addEventListener("click", (e) => {
      if (!menuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
        const hidden = mobileMenu.hasAttribute("hidden");
        if (!hidden) {
          mobileMenu.setAttribute("hidden", "");
          menuBtn.classList.remove("active");
          document.body.classList.remove("menu-open");
        }
      }
    });
  }

  // Verificar sesiÃ³n y actualizar botÃ³n de usuario
  (async function checkAuthStatus() {
    const userBtn = document.getElementById("userNavBtn");
    const userMobileBtn = document.getElementById("userNavMobileBtn");
    const userNameDisplay = document.getElementById("userNameDisplay");
    const userNameMobileDisplay = document.getElementById(
      "userNameMobileDisplay"
    );
    const userMobileLabel = document.getElementById("userMobileLabel");
    const appsLink = document.getElementById("appsLink");
    const productosLink = document.getElementById("productosLink");

    // Primero intentar con token en localStorage
    const token = localStorage.getItem("adminToken");

    try {
      const headers = token ? { Authorization: `Bearer ${token}` } : {};
      const res = await fetch("/api/auth/me", {
        credentials: "include",
        headers: headers,
      });

      if (res.ok) {
        const user = await res.json();
        // Usuario logueado - mostrar nombre
        const firstName = user.first_name || "Usuario";

        if (userNameDisplay) {
          userNameDisplay.textContent = firstName;
          userNameDisplay.style.display = "inline";
        }
        if (userNameMobileDisplay) {
          userNameMobileDisplay.textContent = firstName;
          userNameMobileDisplay.style.display = "inline";
        }
        if (userMobileLabel) {
          userMobileLabel.textContent = firstName;
        }
        if (userBtn) {
          userBtn.href = "/cuenta";
          userBtn.setAttribute("aria-label", `Cuenta de ${firstName}`);
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/cuenta";
          userMobileBtn.setAttribute("aria-label", `Cuenta de ${firstName}`);
        }

        // Mostrar "Panel de apps" solo si es admin
        if (appsLink && user.role === "admin") {
          appsLink.style.display = "block";
        }

        // Mostrar "Productos" solo si es admin
        if (productosLink && user.role === "admin") {
          productosLink.style.display = "block";
        }

        // Mostrar "AuditorÃ­a" solo si es admin
        const auditLink = document.getElementById("auditLink");
        if (auditLink && user.role === "admin") {
          auditLink.style.display = "block";
        }

        // Guardar nombre en localStorage para persistencia
        localStorage.setItem("userName", firstName);
      } else if (res.status === 401) {
        // Solo borrar localStorage si es un error de autenticaciÃ³n (401)
        // Otros errores (500, 503) no deben cerrar la sesiÃ³n del usuario
        localStorage.removeItem("adminToken");
        localStorage.removeItem("userName");
        if (userBtn) {
          userBtn.href = "/login";
          userBtn.setAttribute("aria-label", "Iniciar sesiÃ³n");
        }
        if (userMobileBtn) {
          userMobileBtn.href = "/login";
          userMobileBtn.setAttribute("aria-label", "Iniciar sesiÃ³n");
        }
      } else {
        // Error del servidor (500, etc) - mantener sesiÃ³n con datos guardados
        console.warn(
          "[Header] Error del servidor en /api/auth/me:",
          res.status
        );
        const savedName = localStorage.getItem("userName");
        if (savedName && token) {
          if (userNameDisplay) {
            userNameDisplay.textContent = savedName;
            userNameDisplay.style.display = "inline";
          }
          if (userNameMobileDisplay) {
            userNameMobileDisplay.textContent = savedName;
            userNameMobileDisplay.style.display = "inline";
          }
          if (userBtn) userBtn.href = "/cuenta";
          if (userMobileBtn) userMobileBtn.href = "/cuenta";
        } else {
          if (userBtn) userBtn.href = "/login";
          if (userMobileBtn) userMobileBtn.href = "/login";
        }
      }
    } catch (err) {
      // Error en la verificaciÃ³n - intentar mostrar nombre guardado
      const savedName = localStorage.getItem("userName");
      if (savedName) {
        if (userNameDisplay) {
          userNameDisplay.textContent = savedName;
          userNameDisplay.style.display = "inline";
        }
        if (userNameMobileDisplay) {
          userNameMobileDisplay.textContent = savedName;
          userNameMobileDisplay.style.display = "inline";
        }
        if (userBtn) userBtn.href = "/cuenta";
        if (userMobileBtn) userMobileBtn.href = "/cuenta";
      } else {
        if (userBtn) userBtn.href = "/login";
        if (userMobileBtn) userMobileBtn.href = "/login";
      }
    }
  })();

  // Dropdown menu logic
  (function initUserDropdown() {
    const userDropdown = document.getElementById("userDropdown");
    const userBtn = document.getElementById("userNavBtn");
    const dropdownMenu = document.getElementById("userDropdownMenu");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!userBtn || !userDropdown || !dropdownMenu) return;

    // FunciÃ³n para posicionar el dropdown
    function positionDropdown() {
      const rect = userBtn.getBoundingClientRect();
      dropdownMenu.style.top = rect.bottom + 8 + "px";
      dropdownMenu.style.right = window.innerWidth - rect.right + "px";
    }

    // Toggle dropdown al hacer click en el botÃ³n
    userBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      userDropdown.classList.toggle("active");
      userBtn.setAttribute(
        "aria-expanded",
        userDropdown.classList.contains("active")
      );
      if (userDropdown.classList.contains("active")) {
        positionDropdown();
      }
    });

    // Cerrar dropdown al hacer click en un item
    dropdownMenu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        userDropdown.classList.remove("active");
        userBtn.setAttribute("aria-expanded", "false");
      });
    });

    // Logout
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          const response = await fetch("/api/auth/logout", {
            method: "POST",
            credentials: "include",
          });

          if (response.ok) {
            localStorage.removeItem("adminToken");
            localStorage.removeItem("userName");
            window.location.href = "/login";
          }
        } catch (err) {
          console.error("Error al cerrar sesiÃ³n:", err);
        }
      });
    }

    // Cerrar dropdown al hacer clic fuera
    document.addEventListener("click", (e) => {
      if (!userDropdown.contains(e.target)) {
        userDropdown.classList.remove("active");
        userBtn.setAttribute("aria-expanded", "false");
      }
    });
  })();

  // Establecer altura dinÃ¡mica del header para usar en CSS
  (function setHeaderHeight() {
    const header = document.querySelector(".site-header");
    if (!header) return;

    function updateHeaderHeight() {
      const height = header.offsetHeight;
      document.documentElement.style.setProperty(
        "--header-height",
        height + "px"
      );
    }

    // Ejecutar al cargar
    updateHeaderHeight();

    // Actualizar cuando se redimensiona la ventana
    window.addEventListener("resize", updateHeaderHeight);
  })();
</script>

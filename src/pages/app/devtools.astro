---
import AppLayout from "../../layouts/AppLayout.astro";
---

<AppLayout>
  <div style="max-width: 1000px; margin: 0 auto; padding: 2rem 1.5rem;">
    <div
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;"
    >
      <h1 style="font-size: 2rem; font-weight: 700; color: #251a14; margin: 0;">
        ‚öôÔ∏è DevTools
      </h1>
    </div>

    <!-- Advertencia -->
    <div
      style="background: #fee2e2; border: 2px solid #fca5a5; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;"
    >
      <strong style="color: #dc2626; font-size: 1.1rem;">‚ö†Ô∏è ADVERTENCIA</strong>
      <p style="color: #991b1b; margin-top: 0.5rem; line-height: 1.6;">
        Estas herramientas son destructivas y no pueden deshacerse. Solo para
        desarrollo y testing. √ösalas en bases de datos de prueba, no en
        producci√≥n.
      </p>
    </div>

    <!-- Opciones de Limpieza -->
    <div style="display: grid; gap: 1.5rem;">
      <!-- Limpiar Usuarios -->
      <div
        style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;"
      >
        <div
          style="display: flex; justify-content: space-between; align-items: start;"
        >
          <div>
            <h2
              style="font-size: 1.25rem; font-weight: 600; color: #251a14; margin: 0;"
            >
              üóëÔ∏è Limpiar Usuarios
            </h2>
            <p style="color: #666; margin-top: 0.5rem; font-size: 0.95rem;">
              Elimina todos los usuarios excepto los 2 primeros (admins).
              Mantiene la integridad del sistema.
            </p>
          </div>
          <button
            id="cleanUsersBtn"
            data-endpoint="/api/devtools/clean-users"
            data-status="cleanUsersStatus"
            style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
            onmouseover="this.style.background='#b91c1c'"
            onmouseout="this.style.background='#dc2626'"
          >
            Ejecutar
          </button>
        </div>
        <div id="cleanUsersStatus" style="margin-top: 1rem; font-size: 0.9rem;">
        </div>
      </div>

      <!-- Limpiar Lotes de Caf√© -->
      <div
        style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;"
      >
        <div
          style="display: flex; justify-content: space-between; align-items: start;"
        >
          <div>
            <h2
              style="font-size: 1.25rem; font-weight: 600; color: #251a14; margin: 0;"
            >
              üóëÔ∏è Limpiar Lotes de Caf√©
            </h2>
            <p style="color: #666; margin-top: 0.5rem; font-size: 0.95rem;">
              Elimina todos los lotes de caf√© registrados en el sistema
              (cosechas, inventarios, tostiones).
            </p>
          </div>
          <button
            id="cleanLotsBtn"
            data-endpoint="/api/devtools/clean-lots"
            data-status="cleanLotsStatus"
            style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
            onmouseover="this.style.background='#b91c1c'"
            onmouseout="this.style.background='#dc2626'"
          >
            Ejecutar
          </button>
        </div>
        <div id="cleanLotsStatus" style="margin-top: 1rem; font-size: 0.9rem;">
        </div>
      </div>

      <!-- Limpiar Productos -->
      <div
        style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;"
      >
        <div
          style="display: flex; justify-content: space-between; align-items: start;"
        >
          <div>
            <h2
              style="font-size: 1.25rem; font-weight: 600; color: #251a14; margin: 0;"
            >
              üóëÔ∏è Limpiar Productos
            </h2>
            <p style="color: #666; margin-top: 0.5rem; font-size: 0.95rem;">
              Elimina todos los productos disponibles en la tienda en l√≠nea.
            </p>
          </div>
          <button
            id="cleanProductsBtn"
            data-endpoint="/api/devtools/clean-products"
            data-status="cleanProductsStatus"
            style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
            onmouseover="this.style.background='#b91c1c'"
            onmouseout="this.style.background='#dc2626'"
          >
            Ejecutar
          </button>
        </div>
        <div
          id="cleanProductsStatus"
          style="margin-top: 1rem; font-size: 0.9rem;"
        >
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n -->
  <div
    id="confirmModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;"
  >
    <div
      style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; box-shadow: 0 20px 25px rgba(0,0,0,0.15);"
    >
      <h2 style="color: #dc2626; margin-top: 0; font-size: 1.5rem;">
        ‚ö†Ô∏è Confirma esta acci√≥n destructiva
      </h2>
      <p style="color: #666; line-height: 1.6; margin: 1rem 0;">
        Esta acci√≥n <strong>no se puede deshacer</strong>. Para confirmar que
        realmente deseas proceder, ingresa el link del repositorio de GitHub:
      </p>
      <p
        style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem; color: #333; margin: 1rem 0;"
      >
        github.com/mikerb95/dobleyo
      </p>
      <input
        id="confirmInput"
        type="text"
        placeholder="Pega el link del repositorio aqu√≠..."
        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 0.9rem; box-sizing: border-box; margin-bottom: 1rem;"
      />
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button
          id="cancelBtn"
          style="padding: 0.75rem 1.5rem; background: #e5e7eb; color: #333; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
          onmouseover="this.style.background='#d1d5db'"
          onmouseout="this.style.background='#e5e7eb'"
        >
          Cancelar
        </button>
        <button
          id="confirmBtn"
          style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
          onmouseover="this.style.background='#b91c1c'"
          onmouseout="this.style.background='#dc2626'"
        >
          Confirmar y Ejecutar
        </button>
      </div>
    </div>
  </div>

  <script is:inline>
    const REPO_LINK = "github.com/mikerb95/dobleyo";
    let pendingAction = null;

    function showConfirmModal(action) {
      pendingAction = action;
      const modal = document.getElementById("confirmModal");
      const input = document.getElementById("confirmInput");
      modal.style.display = "flex";
      input.value = "";
      input.focus();
    }

    function hideConfirmModal() {
      const modal = document.getElementById("confirmModal");
      modal.style.display = "none";
      pendingAction = null;
    }

    document
      .getElementById("cancelBtn")
      ?.addEventListener("click", hideConfirmModal);

    document
      .getElementById("confirmBtn")
      ?.addEventListener("click", async () => {
        const input = document.getElementById("confirmInput");
        if (input.value.trim() !== REPO_LINK) {
          alert(
            "‚ùå El link del repositorio no es correcto. Por favor, intenta nuevamente."
          );
          input.focus();
          return;
        }

        hideConfirmModal();
        if (pendingAction) {
          await executeCleanup(pendingAction.endpoint, pendingAction.statusId);
        }
      });

    // Permitir Enter en el input
    document
      .getElementById("confirmInput")
      ?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("confirmBtn").click();
        }
      });

    async function executeCleanup(endpoint, statusElementId) {
      const statusEl = document.getElementById(statusElementId);
      let button = null;
      
      // Encontrar el bot√≥n asociado a este status
      document.querySelectorAll("button[data-status]").forEach(btn => {
        if (btn.dataset.status === statusElementId) {
          button = btn;
        }
      });

      if (button) button.disabled = true;
      statusEl.innerHTML =
        '<div style="color: #3b82f6; font-weight: 600;">‚è≥ Procesando...</div>';

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || "Error en la respuesta del servidor");
        }

        // Mostrar mensaje principal con estilo mejorado
        let html = `<div style="color: #16a34a; font-weight: 700; font-size: 1rem; margin-bottom: 1rem;">
          ${result.message}
        </div>`;

        // Mostrar detalles si existen (el log de acciones)
        if (result.details && Array.isArray(result.details)) {
          html += '<div style="background: #f9fafb; border-left: 4px solid #16a34a; padding: 1rem; border-radius: 4px; font-size: 0.85rem; color: #333; font-family: monospace;">';
          result.details.forEach((detail) => {
            // Colorear seg√∫n si es √©xito (‚úì), advertencia (‚ö†) o info
            let color = "#666";
            if (detail.includes("‚úì")) color = "#16a34a";
            else if (detail.includes("‚ö†")) color = "#d97706";
            
            html += `<div style="padding: 0.4rem 0; color: ${color}; line-height: 1.5;">${detail}</div>`;
          });
          html += "</div>";
        }

        // Mostrar count si existe
        if (result.deletedCount !== undefined) {
          html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.9rem; color: #666;">
            <strong>Tablas procesadas:</strong> ${result.deletedCount}
          </div>`;
        }

        statusEl.innerHTML = html;
      } catch (error) {
        statusEl.innerHTML = `<div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 1rem; border-radius: 4px; color: #dc2626; font-weight: 600;">‚ùå Error: ${error.message}</div>`;
        console.error(error);
      } finally {
        if (button) button.disabled = false;
      }
    }

    document.getElementById("cleanUsersBtn")?.addEventListener("click", () => {
      showConfirmModal({
        endpoint: "/api/devtools/clean-users",
        statusId: "cleanUsersStatus",
      });
    });

    document.getElementById("cleanLotsBtn")?.addEventListener("click", () => {
      showConfirmModal({
        endpoint: "/api/devtools/clean-lots",
        statusId: "cleanLotsStatus",
      });
    });

    document
      .getElementById("cleanProductsBtn")
      ?.addEventListener("click", () => {
        showConfirmModal({
          endpoint: "/api/devtools/clean-products",
          statusId: "cleanProductsStatus",
        });
      });
  </script>
</AppLayout>

---
import AppLayout from "../../layouts/AppLayout.astro";
---

<AppLayout>
  <div style="max-width: 1400px; margin: 0 auto; padding: 1.5rem;">
    <div style="margin-bottom: 1.5rem;">
      <h1 style="font-size: 2rem; font-weight: 700; color: #8b6f47; margin-bottom: 1rem;">
        üìã Auditor√≠a y Logs
      </h1>
      <p style="color: #666; margin: 0;">
        Registro de todas las acciones realizadas en el sistema
      </p>
    </div>

    <!-- Filtros -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <select id="actionFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">Todas las acciones</option>
      </select>

      <input
        type="text"
        id="entityIdFilter"
        placeholder="Filtrar por ID de entidad..."
        style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
      />

      <input
        type="text"
        id="userFilter"
        placeholder="Filtrar por usuario (email)..."
        style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
      />

      <button
        onclick="applyFilters()"
        style="padding: 0.5rem 1rem; background: #8b6f47; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;"
      >
        üîç Filtrar
      </button>
      
      <button
        onclick="resetFilters()"
        style="padding: 0.5rem 1rem; background: #ddd; color: #333; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;"
      >
        ‚Üª Limpiar
      </button>
    </div>

    <!-- Loading -->
    <div id="loading" style="text-align: center; padding: 2rem; color: #666;">
      Cargando logs de auditor√≠a...
    </div>

    <!-- Tabla de logs -->
    <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <table id="logsTable" style="width: 100%; border-collapse: collapse; display: none;">
        <thead>
          <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Fecha</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Usuario</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Acci√≥n</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Tipo</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">ID Entidad</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Detalles</th>
          </tr>
        </thead>
        <tbody id="logsTableBody"></tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    <div id="pagination" style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; align-items: center;">
    </div>

    <!-- Estad√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
      <div style="background: #f0f9ff; border-radius: 8px; padding: 1.5rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #0369a1;" id="statTotal">0</div>
        <div style="color: #666; font-size: 0.9rem;">Total de registros</div>
      </div>
      <div style="background: #f0fdf4; border-radius: 8px; padding: 1.5rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #15803d;" id="statCreates">0</div>
        <div style="color: #666; font-size: 0.9rem;">Creaciones</div>
      </div>
      <div style="background: #fef3c7; border-radius: 8px; padding: 1.5rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #b45309;" id="statUpdates">0</div>
        <div style="color: #666; font-size: 0.9rem;">Actualizaciones</div>
      </div>
      <div style="background: #fee2e2; border-radius: 8px; padding: 1.5rem; text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #991b1b;" id="statDeletes">0</div>
        <div style="color: #666; font-size: 0.9rem;">Eliminaciones</div>
      </div>
    </div>
  </div>

  <script>
    let allLogs = [];
    let currentPage = 1;
    const logsPerPage = 50;

    async function loadLogs() {
      try {
        const response = await fetch("/api/audit/logs?limit=500", {
          credentials: "include",
        });

        if (!response.ok) {
          throw new Error("Error al cargar logs");
        }

        const data = await response.json();
        allLogs = data.logs || [];

        displayLogs();
        updateStats();
        loadActions();

        document.getElementById("loading").style.display = "none";
        document.getElementById("logsTable").style.display = "table";
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("loading").textContent = "Error al cargar los logs de auditor√≠a";
      }
    }

    async function loadActions() {
      try {
        const response = await fetch("/api/audit/actions", {
          credentials: "include",
        });

        if (!response.ok) return;

        const data = await response.json();
        const select = document.getElementById("actionFilter");
        
        data.actions.forEach(action => {
          const option = document.createElement("option");
          option.value = action;
          option.textContent = action.charAt(0).toUpperCase() + action.slice(1);
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading actions:", err);
      }
    }

    function displayLogs() {
      const tbody = document.getElementById("logsTableBody");
      tbody.innerHTML = "";

      if (allLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: #666;">No hay registros de auditor√≠a</td></tr>';
        return;
      }

      const start = (currentPage - 1) * logsPerPage;
      const end = start + logsPerPage;
      const paginatedLogs = allLogs.slice(start, end);

      paginatedLogs.forEach((log) => {
        const row = document.createElement("tr");
        row.style.borderBottom = "1px solid #e5e7eb";
        row.style.transition = "background-color 0.2s";
        row.onmouseenter = () => (row.style.backgroundColor = "#f9fafb");
        row.onmouseleave = () => (row.style.backgroundColor = "transparent");

        const date = new Date(log.created_at);
        const dateStr = date.toLocaleDateString("es-ES") + " " + date.toLocaleTimeString("es-ES");

        const actionColors = {
          create: "#10b981",
          update: "#f59e0b",
          delete: "#ef4444",
          harvest: "#3b82f6",
          store: "#8b5cf6",
          roast_send: "#ec4899",
          roast_receive: "#06b6d4"
        };

        const userName = log.first_name || log.last_name 
          ? `${log.first_name || ""} ${log.last_name || ""}`.trim()
          : log.user_email || "Sistema";

        row.innerHTML = `
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">${dateStr}</td>
          <td style="padding: 1rem; font-weight: 500;">${userName}</td>
          <td style="padding: 1rem;">
            <span style="background: ${actionColors[log.action] || '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">
              ${log.action}
            </span>
          </td>
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">${log.entity_type}</td>
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">${log.entity_id}</td>
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">
            <button onclick="showDetails('${btoa(JSON.stringify(log.details))}', '${log.action}', '${log.entity_type}', '${log.entity_id}')" 
              style="background: #e5e7eb; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
              Ver
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });

      renderPagination();
    }

    function renderPagination() {
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      const totalPages = Math.ceil(allLogs.length / logsPerPage);

      if (totalPages <= 1) return;

      if (currentPage > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "‚Üê Anterior";
        prevBtn.style.cssText = "padding: 0.5rem 1rem; background: #8b6f47; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;";
        prevBtn.onclick = () => {
          currentPage--;
          displayLogs();
          window.scrollTo(0, 0);
        };
        container.appendChild(prevBtn);
      }

      const pageSpan = document.createElement("span");
      pageSpan.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      pageSpan.style.color = "#666";
      container.appendChild(pageSpan);

      if (currentPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Siguiente ‚Üí";
        nextBtn.style.cssText = "padding: 0.5rem 1rem; background: #8b6f47; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;";
        nextBtn.onclick = () => {
          currentPage++;
          displayLogs();
          window.scrollTo(0, 0);
        };
        container.appendChild(nextBtn);
      }
    }

    function updateStats() {
      const stats = {
        total: allLogs.length,
        create: allLogs.filter(l => l.action === 'create').length,
        update: allLogs.filter(l => l.action === 'update').length,
        delete: allLogs.filter(l => l.action === 'delete').length
      };

      document.getElementById("statTotal").textContent = stats.total;
      document.getElementById("statCreates").textContent = stats.create;
      document.getElementById("statUpdates").textContent = stats.update;
      document.getElementById("statDeletes").textContent = stats.delete;
    }

    function applyFilters() {
      const action = document.getElementById("actionFilter").value;
      const entityId = document.getElementById("entityIdFilter").value.toLowerCase();
      const user = document.getElementById("userFilter").value.toLowerCase();

      const filtered = allLogs.filter(log => {
        const matchAction = !action || log.action === action;
        const matchEntity = !entityId || log.entity_id.toLowerCase().includes(entityId);
        const matchUser = !user || (log.user_email || "").toLowerCase().includes(user) || 
                         `${log.first_name || ""} ${log.last_name || ""}`.toLowerCase().includes(user);
        return matchAction && matchEntity && matchUser;
      });

      allLogs = filtered;
      currentPage = 1;
      displayLogs();
      updateStats();
    }

    function resetFilters() {
      document.getElementById("actionFilter").value = "";
      document.getElementById("entityIdFilter").value = "";
      document.getElementById("userFilter").value = "";
      loadLogs();
    }

    function showDetails(encodedDetails, action, entityType, entityId) {
      try {
        const details = JSON.parse(atob(encodedDetails));
        const detailsStr = JSON.stringify(details, null, 2);
        alert(`Detalles de la acci√≥n:\n\nAcci√≥n: ${action}\nTipo: ${entityType}\nID: ${entityId}\n\n${detailsStr}`);
      } catch (err) {
        alert("No hay detalles adicionales para esta acci√≥n");
      }
    }

    loadLogs();
  </script>
</AppLayout>

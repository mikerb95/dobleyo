---
import AppLayout from "../../layouts/AppLayout.astro";
---

<AppLayout>
  <div style="max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem;">
    <div
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;"
    >
      <h1 style="font-size: 2rem; font-weight: 700; color: #251a14; margin: 0;">
        üå± Gesti√≥n de Lotes
      </h1>
    </div>

    <!-- Filtros -->
    <div
      style="background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
    >
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <input
          type="search"
          id="searchInput"
          placeholder="Buscar por nombre o ID..."
          style="flex: 1; min-width: 250px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;"
        />
        <select
          id="statusFilter"
          style="padding: 0.75rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;"
        >
          <option value="">Todos los estados</option>
          <option value="verde">Verde</option>
          <option value="en_tostado">En Tostado</option>
          <option value="tostado">Tostado (Almacenado)</option>
          <option value="pendiente">Pendiente de Almacenar</option>
        </select>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;"
    >
      <div
        style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #251a14;"
          id="totalLotes"
        >
          0
        </div>
        <div style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
          Lotes Totales
        </div>
      </div>
      <div
        style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #4a6741;"
          id="totalVerde"
        >
          0
        </div>
        <div style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
          Verde
        </div>
      </div>
      <div
        style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #7c2d12;"
          id="totalEnTostado"
        >
          0
        </div>
        <div style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
          En Tostado
        </div>
      </div>
      <div
        style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #8b6f47;"
          id="totalTostado"
        >
          0
        </div>
        <div style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
          Tostado
        </div>
      </div>
      <div
        style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #ea580c;"
          id="totalPendiente"
        >
          0
        </div>
        <div style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
          Pendiente Almacenar
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div
      style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); overflow: hidden;"
    >
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
              <th
                style="padding: 1rem; text-align: left; font-weight: 600; color: #251a14;"
                >ID Lote</th
              >
              <th
                style="padding: 1rem; text-align: left; font-weight: 600; color: #251a14;"
                >Finca</th
              >
              <th
                style="padding: 1rem; text-align: left; font-weight: 600; color: #251a14;"
                >Variedad</th
              >
              <th
                style="padding: 1rem; text-align: center; font-weight: 600; color: #251a14;"
                >Peso (kg)</th
              >
              <th
                style="padding: 1rem; text-align: center; font-weight: 600; color: #251a14;"
                >Estado</th
              >
              <th
                style="padding: 1rem; text-align: left; font-weight: 600; color: #251a14;"
                >Fecha</th
              >
              <th
                style="padding: 1rem; text-align: center; font-weight: 600; color: #251a14;"
                >Acciones</th
              >
            </tr>
          </thead>
          <tbody id="lotesTable">
            <tr>
              <td
                colspan="6"
                style="padding: 2rem; text-align: center; color: #666;"
                >Cargando lotes...</td
              >
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div
      id="deleteModal"
      style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;"
    >
      <div
        style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; margin: 2rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);"
      >
        <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; color: #251a14;">
          ‚ö†Ô∏è Confirmar Eliminaci√≥n
        </h3>
        <p style="color: #666; margin-bottom: 1.5rem;">
          ¬øEst√°s seguro de que deseas eliminar el lote <strong id="deleteLotId"
          ></strong>?
        </p>
        <p style="color: #ef4444; font-size: 0.9rem; margin-bottom: 1.5rem;">
          Esta acci√≥n no se puede deshacer.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button
            onclick="closeDeleteModal()"
            style="padding: 0.75rem 1.5rem; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;"
          >
            Cancelar
          </button>
          <button
            id="confirmDeleteBtn"
            style="padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;"
          >
            S√≠, Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Solo admins pueden ver esta p√°gina
    (async function () {
      try {
        const response = await fetch("/api/auth/me", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("adminToken")}`,
          },
          credentials: "include",
        });

        if (!response.ok || response.status === 401) {
          alert(
            "Acceso denegado. Solo administradores pueden ver esta p√°gina."
          );
          window.location.href = "/app";
          return;
        }

        const user = await response.json();
        if (user.role !== "admin") {
          alert(
            "Acceso denegado. Solo administradores pueden ver esta p√°gina."
          );
          window.location.href = "/app";
          return;
        }

        // Cargar lotes
        loadLotes();

        // Event listeners
        document
          .getElementById("searchInput")
          .addEventListener("input", filterLotes);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterLotes);
      } catch (error) {
        console.error("Error:", error);
        window.location.href = "/app";
      }
    })();

    let allLotes = [];

    async function loadLotes() {
      try {
        console.log("[Lotes Page] Iniciando carga desde /api/coffee/lots");

        const response = await fetch("/api/coffee/lots", {
          credentials: "include",
        });

        console.log("[Lotes Page] Response status:", response.status);

        if (!response.ok) {
          console.error(
            "[Lotes Page] Response error:",
            response.status,
            response.statusText
          );
          throw new Error(`Error al cargar lotes: ${response.status}`);
        }

        const data = await response.json();
        console.log("[Lotes Page] Data recibida:", data);

        allLotes = data.lots || [];
        console.log("[Lotes Page] Total lotes cargados:", allLotes.length);

        displayLotes(allLotes);
        updateStats(allLotes);
      } catch (error) {
        console.error("[Lotes Page] Error completo:", error);
        document.getElementById("lotesTable").innerHTML = `
          <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: #c00;">
              Error al cargar los lotes: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    function displayLotes(lotes) {
      const tbody = document.getElementById("lotesTable");

      if (lotes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding: 2rem; text-align: center; color: #666;">
              No hay lotes disponibles
            </td>
          </tr>
        `;
        return;
      }

      const statusColors = {
        verde: "background: #d1fae5; color: #065f46;",
        en_tostado: "background: #fef3c7; color: #92400e;",
        tostado: "background: #fed7aa; color: #92400e;",
        pendiente: "background: #fef3c7; color: #ea580c;",
      };

      const statusLabels = {
        verde: "Verde",
        en_tostado: "En Tostado",
        tostado: "Tostado",
        pendiente: "Pendiente",
      };

      tbody.innerHTML = lotes
        .map((lote) => {
          const statusStyle = statusColors[lote.status] || "";

          return `
          <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='transparent'">
            <td style="padding: 1rem; font-family: monospace; font-weight: 600; color: #251a14;">${lote.lot_id || "‚Äî"}</td>
            <td style="padding: 1rem;">${lote.farm_name || "‚Äî"}</td>
            <td style="padding: 1rem;">${lote.variety || "‚Äî"}</td>
            <td style="padding: 1rem; text-align: center;">${(lote.weight || 0).toFixed(2)}</td>
            <td style="padding: 1rem; text-align: center;">
              <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; ${statusStyle}">
                ${statusLabels[lote.status] || lote.status || "Desconocido"}
              </span>
            </td>
            <td style="padding: 1rem; font-size: 0.9rem; color: #666;">
              ${lote.created_at ? new Date(lote.created_at).toLocaleDateString("es-ES") : "‚Äî"}
            </td>
            <td style="padding: 1rem; text-align: center;">
              <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button 
                  onclick="editLote('${lote.lot_id}', '${lote.status}', ${lote.id})" 
                  style="padding: 0.5rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#2563eb'"
                  onmouseout="this.style.background='#3b82f6'"
                  title="Editar lote"
                >
                  ‚úèÔ∏è Editar
                </button>
                <button 
                  onclick="confirmDelete('${lote.lot_id}', '${lote.status}', ${lote.id})" 
                  style="padding: 0.5rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: background 0.2s;"
                  onmouseover="this.style.background='#dc2626'"
                  onmouseout="this.style.background='#ef4444'"
                  title="Eliminar lote"
                >
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </td>
          </tr>
        `;
        })
        .join("");
    }

    function filterLotes() {
      const searchTerm = document
        .getElementById("searchInput")
        .value.toLowerCase();
      const status = document.getElementById("statusFilter").value;

      const filtered = allLotes.filter((lote) => {
        const matchesSearch =
          !searchTerm ||
          (lote.lot_id && lote.lot_id.toLowerCase().includes(searchTerm)) ||
          (lote.farm_name && lote.farm_name.toLowerCase().includes(searchTerm));

        const matchesStatus = !status || lote.status === status;

        return matchesSearch && matchesStatus;
      });

      displayLotes(filtered);
    }

    function updateStats(lotes) {
      document.getElementById("totalLotes").textContent = lotes.length;
      document.getElementById("totalVerde").textContent = lotes.filter(
        (l) => l.status === "verde"
      ).length;
      document.getElementById("totalEnTostado").textContent = lotes.filter(
        (l) => l.status === "en_tostado"
      ).length;
      document.getElementById("totalTostado").textContent = lotes.filter(
        (l) => l.status === "tostado"
      ).length;
      document.getElementById("totalPendiente").textContent = lotes.filter(
        (l) => l.status === "pendiente"
      ).length;
    }

    // Funci√≥n para editar lote
    function editLote(lotId, status, id) {
      console.log("[Editar Lote]", { lotId, status, id });

      // Redirigir a la p√°gina de edici√≥n seg√∫n el estado del lote
      if (status === "verde") {
        window.location.href = `/app/edit-harvest?lotId=${encodeURIComponent(lotId)}`;
      } else if (status === "tostado") {
        window.location.href = `/app/edit-roasted-storage?id=${id}`;
      } else if (status === "pendiente") {
        window.location.href = `/app/edit-roasted?id=${id}`;
      }
    }

    // Variables para el modal de eliminaci√≥n
    let deleteTarget = null;

    // Funci√≥n para mostrar modal de confirmaci√≥n
    function confirmDelete(lotId, status, id) {
      deleteTarget = { lotId, status, id };
      document.getElementById("deleteLotId").textContent = lotId;
      const modal = document.getElementById("deleteModal");
      modal.style.display = "flex";
    }

    // Funci√≥n para cerrar modal
    function closeDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
      deleteTarget = null;
    }

    // Funci√≥n para confirmar y ejecutar eliminaci√≥n
    document
      .getElementById("confirmDeleteBtn")
      .addEventListener("click", async function () {
        if (!deleteTarget) return;

        try {
          console.log("[Eliminar Lote]", deleteTarget);

          const { lotId, status, id } = deleteTarget;
          let endpoint = "";

          // Determinar el endpoint seg√∫n el estado
          if (status === "verde") {
            endpoint = `/api/coffee/harvest/${encodeURIComponent(lotId)}`;
          } else if (status === "tostado") {
            endpoint = `/api/coffee/roasted-storage/${id}`;
          } else if (status === "pendiente") {
            endpoint = `/api/coffee/roasted-coffee/${id}`;
          }

          const response = await fetch(endpoint, {
            method: "DELETE",
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Error al eliminar el lote");
          }

          // Cerrar modal
          closeDeleteModal();

          // Recargar lotes
          await loadLotes();

          alert("‚úì Lote eliminado correctamente");
        } catch (error) {
          console.error("[Eliminar Lote] Error:", error);
          alert("Error al eliminar el lote: " + error.message);
        }
      });

    // Cerrar modal al hacer clic fuera
    document
      .getElementById("deleteModal")
      .addEventListener("click", function (e) {
        if (e.target === this) {
          closeDeleteModal();
        }
      });
  </script>
</AppLayout>

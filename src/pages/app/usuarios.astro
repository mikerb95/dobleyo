---
import AppLayout from "../../layouts/AppLayout.astro";
---

<AppLayout>
  <div style="max-width: 1400px; margin: 0 auto; padding: 1.5rem;">
    <div
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;"
    >
      <h1 style="font-size: 2rem; font-weight: 700; color: #8b6f47;">
        üë• Gesti√≥n de Usuarios
      </h1>
      <div style="display: flex; gap: 0.75rem;">
        <button
          onclick="window.open('https://mailadmin.zoho.com/cpanel/home.do#subscription/dashboard', '_blank')"
          style="background: #8b6f47; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s;"
          onmouseover="this.style.background='#6b5437'"
          onmouseout="this.style.background='#8b6f47'"
          title="Abrir panel de administraci√≥n de correos Zoho"
        >
          üìß Zoho Admin
        </button>
        <button
          onclick="window.open('https://mail.zoho.com/zm/#mail/folder/inbox', '_blank')"
          style="background: #8b6f47; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s;"
          onmouseover="this.style.background='#6b5437'"
          onmouseout="this.style.background='#8b6f47'"
          title="Abrir correo de Zoho"
        >
          ‚úâÔ∏è Zoho Mail
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div
      style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;"
    >
      <select
        id="roleFilter"
        style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;"
      >
        <option value="">Todos los roles</option>
        <option value="admin">Admin</option>
        <option value="caficultor">Caficultor</option>
        <option value="client">Cliente</option>
      </select>

      <input
        type="search"
        id="searchInput"
        placeholder="Buscar por nombre o email..."
        style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; flex: 1; min-width: 250px;"
      />
    </div>

    <!-- Loading -->
    <div id="loading" style="text-align: center; padding: 2rem; color: #666;">
      Cargando usuarios...
    </div>

    <!-- Error -->
    <div
      id="error"
      style="display: none; background: #fee; border: 1px solid #fcc; border-radius: 6px; padding: 1rem; color: #c00;"
    >
    </div>

    <!-- Tabla de usuarios -->
    <div
      style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
    >
      <table
        id="usersTable"
        style="width: 100%; border-collapse: collapse; display: none;"
      >
        <thead>
          <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >ID</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Nombre</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Apellido</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Email</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Tel√©fono</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Rol</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Estado</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >√öltimo login</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Registrado</th
            >
            <th
              style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;"
              >Acciones</th
            >
          </tr>
        </thead>
        <tbody id="usersTableBody"> </tbody>
      </table>
    </div>

    <!-- Modal Editar Usuario -->
    <div
      id="editModal"
      style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;"
    >
      <div
        style="background: white; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%;"
      >
        <h2 style="margin-bottom: 1.5rem; color: #251a14;">Editar Usuario</h2>
        <form id="editForm">
          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Nombre:</label
            >
            <input
              type="text"
              id="editFirstName"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Apellido:</label
            >
            <input
              type="text"
              id="editLastName"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Email:</label
            >
            <input
              type="email"
              id="editEmail"
              disabled
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;"
            />
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Tel√©fono:</label
            >
            <input
              type="text"
              id="editPhone"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Rol:</label
            >
            <select
              id="editRole"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            >
              <option value="client">Cliente</option>
              <option value="caficultor">Caficultor</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Ciudad:</label
            >
            <input
              type="text"
              id="editCity"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Departamento/Estado:</label
            >
            <input
              type="text"
              id="editState"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label
              style="display: block; font-weight: 500; margin-bottom: 0.5rem;"
              >Pa√≠s:</label
            >
            <input
              type="text"
              id="editCountry"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label
              style="display: flex; align-items: center; font-weight: 500;"
            >
              <input
                type="checkbox"
                id="editVerified"
                style="margin-right: 0.5rem;"
              />
              Verificado
            </label>
          </div>

          <div style="display: flex; gap: 1rem;">
            <button
              type="submit"
              style="flex: 1; padding: 0.75rem; background: #8b6f47; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
            >
              Guardar
            </button>
            <button
              type="button"
              onclick="document.getElementById('editModal').style.display = 'none'"
              style="flex: 1; padding: 0.75rem; background: #ddd; color: #333; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Eliminar Usuario -->
    <div
      id="deleteModal"
      style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;"
    >
      <div
        style="background: white; border-radius: 8px; padding: 2rem; max-width: 400px; width: 90%;"
      >
        <h2 style="margin-bottom: 1rem; color: #c00;">Eliminar Usuario</h2>
        <p style="margin-bottom: 1rem; color: #666;">
          ¬øEst√°s seguro de que deseas eliminar este usuario? Esta acci√≥n no se
          puede deshacer.
        </p>
        <p
          style="margin-bottom: 1.5rem; background: #fee; padding: 1rem; border-radius: 4px; color: #c00;"
        >
          Email: <strong id="deleteUserEmail"></strong>
        </p>
        <div style="display: flex; gap: 1rem;">
          <button
            onclick="confirmDelete()"
            style="flex: 1; padding: 0.75rem; background: #c00; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
          >
            Eliminar
          </button>
          <button
            onclick="document.getElementById('deleteModal').style.display = 'none'"
            style="flex: 1; padding: 0.75rem; background: #ddd; color: #333; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Ver Detalles del Usuario -->
    <div
      id="viewModal"
      style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 2rem 0;"
    >
      <div
        style="background: white; border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem auto;"
      >
        <h2 style="margin-bottom: 1.5rem; color: #251a14;">Detalles del Usuario</h2>
        
        <div style="background: #f9fafb; border-radius: 6px; padding: 1.5rem; margin-bottom: 1.5rem;">
          <!-- ID y Email -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">ID:</label>
            <p id="viewUserId" style="margin: 0; color: #666;"></p>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Email:</label>
            <p id="viewUserEmail" style="margin: 0; color: #666; word-break: break-all;"></p>
          </div>

          <!-- Nombre y Apellido -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Nombre:</label>
              <p id="viewUserFirstName" style="margin: 0; color: #666;"></p>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Apellido:</label>
              <p id="viewUserLastName" style="margin: 0; color: #666;"></p>
            </div>
          </div>

          <!-- Tel√©fonos -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Tel√©fono M√≥vil:</label>
              <p id="viewUserMobilePhone" style="margin: 0; color: #666;"></p>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Tel√©fono Fijo:</label>
              <p id="viewUserLandlinePhone" style="margin: 0; color: #666;"></p>
            </div>
          </div>

          <!-- Ubicaci√≥n -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Ciudad:</label>
              <p id="viewUserCity" style="margin: 0; color: #666;"></p>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Departamento:</label>
              <p id="viewUserState" style="margin: 0; color: #666;"></p>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Pa√≠s:</label>
            <p id="viewUserCountry" style="margin: 0; color: #666;"></p>
          </div>

          <!-- Direcci√≥n -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Direcci√≥n:</label>
            <p id="viewUserAddress" style="margin: 0; color: #666;"></p>
          </div>

          <!-- C√©dula/NIT -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">C√©dula/NIT:</label>
            <p id="viewUserTaxId" style="margin: 0; color: #666;"></p>
          </div>

          <!-- Rol y Estado -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Rol:</label>
              <p id="viewUserRole" style="margin: 0; color: #666;"></p>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Estado:</label>
              <p id="viewUserVerified" style="margin: 0; color: #666;"></p>
            </div>
          </div>

          <!-- Caficultor Status -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Estado Caficultor:</label>
            <p id="viewUserCaficultorStatus" style="margin: 0; color: #666;"></p>
          </div>

          <!-- Fechas -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">Registrado:</label>
              <p id="viewUserCreatedAt" style="margin: 0; color: #666; font-size: 0.85rem;"></p>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">√öltimo Login:</label>
              <p id="viewUserLastLogin" style="margin: 0; color: #666; font-size: 0.85rem;"></p>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 1rem;">
          <button
            onclick="document.getElementById('viewModal').style.display = 'none'"
            style="flex: 1; padding: 0.75rem; background: #8b6f47; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;"
    >
      <div
        style="background: #dbeafe; border-radius: 8px; padding: 1.5rem; text-align: center;"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #1e40af;"
          id="totalUsers"
        >
          0
        </div>
        <div style="color: #1e40af; font-size: 0.9rem; margin-top: 0.5rem;">
          Total Usuarios
        </div>
      </div>
      <div
        style="background: #fef3c7; border-radius: 8px; padding: 1.5rem; text-align: center;"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #92400e;"
          id="totalAdmins"
        >
          0
        </div>
        <div style="color: #92400e; font-size: 0.9rem; margin-top: 0.5rem;">
          Administradores
        </div>
      </div>
      <div
        style="background: #d1fae5; border-radius: 8px; padding: 1.5rem; text-align: center;"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #065f46;"
          id="totalCaficultores"
        >
          0
        </div>
        <div style="color: #065f46; font-size: 0.9rem; margin-top: 0.5rem;">
          Caficultores
        </div>
      </div>
      <div
        style="background: #e0e7ff; border-radius: 8px; padding: 1.5rem; text-align: center;"
      >
        <div
          style="font-size: 2rem; font-weight: 700; color: #3730a3;"
          id="totalClients"
        >
          0
        </div>
        <div style="color: #3730a3; font-size: 0.9rem; margin-top: 0.5rem;">
          Clientes
        </div>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];

    async function loadUsers() {
      try {
        const response = await fetch("/api/users", {
          credentials: "include",
        });

        if (!response.ok) {
          throw new Error("Error al cargar usuarios");
        }

        const data = await response.json();
        allUsers = data.users || [];

        displayUsers(allUsers);
        updateStats(allUsers);

        document.getElementById("loading").style.display = "none";
        document.getElementById("usersTable").style.display = "table";
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("loading").style.display = "none";
        const errorDiv = document.getElementById("error");
        errorDiv.textContent =
          "Error al cargar los usuarios. Intenta recargar la p√°gina.";
        errorDiv.style.display = "block";
      }
    }

    function displayUsers(users) {
      const tbody = document.getElementById("usersTableBody");
      tbody.innerHTML = "";

      if (users.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="9" style="padding: 2rem; text-align: center; color: #666;">No se encontraron usuarios</td></tr>';
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.style.borderBottom = "1px solid #e5e7eb";
        row.style.transition = "background-color 0.2s";
        row.onmouseenter = () => (row.style.backgroundColor = "#f9fafb");
        row.onmouseleave = () => (row.style.backgroundColor = "transparent");

        const roleBadgeColors = {
          admin: "background: #fef3c7; color: #92400e;",
          caficultor: "background: #d1fae5; color: #065f46;",
          client: "background: #e0e7ff; color: #3730a3;",
        };

        const verifiedBadge = user.is_verified
          ? '<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">‚úì Verificado</span>'
          : '<span style="background: #fee; color: #c00; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sin verificar</span>';

        row.innerHTML = `
          <td style="padding: 1rem;">${user.id}</td>
          <td style="padding: 1rem; font-weight: 500;">${user.first_name || "‚Äî"}</td>
          <td style="padding: 1rem; font-weight: 500;">${user.last_name || "‚Äî"}</td>
          <td style="padding: 1rem;">${user.email}</td>
          <td style="padding: 1rem;">${user.mobile_phone || "‚Äî"}</td>
          <td style="padding: 1rem;">
            <span style="${roleBadgeColors[user.role] || ""} padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">
              ${user.role}
            </span>
          </td>
          <td style="padding: 1rem;">${verifiedBadge}</td>
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">${user.last_login_at ? new Date(user.last_login_at).toLocaleDateString("es-ES") : "Nunca"}</td>
          <td style="padding: 1rem; font-size: 0.85rem; color: #666;">${new Date(user.created_at).toLocaleDateString("es-ES")}</td>
          <td style="padding: 1rem; white-space: nowrap;">
            <button class="viewBtn" data-user-id="${user.id}" style="padding: 0.4rem 0.8rem; background: #6366f1; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; margin-right: 0.5rem;">üëÅÔ∏è Ver todo</button>
            <button class="editBtn" data-user-id="${user.id}" style="padding: 0.4rem 0.8rem; background: #8b6f47; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; margin-right: 0.5rem;">‚úèÔ∏è Editar</button>
            <button class="deleteBtn" data-user-id="${user.id}" data-user-email="${user.email}" style="padding: 0.4rem 0.8rem; background: #c00; color: white; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">üóëÔ∏è Eliminar</button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function updateStats(users) {
      document.getElementById("totalUsers").textContent = users.length;
      document.getElementById("totalAdmins").textContent = users.filter(
        (u) => u.role === "admin"
      ).length;
      document.getElementById("totalCaficultores").textContent = users.filter(
        (u) => u.role === "caficultor"
      ).length;
      document.getElementById("totalClients").textContent = users.filter(
        (u) => u.role === "client"
      ).length;
    }

    function filterUsers() {
      const roleFilter = document.getElementById("roleFilter").value;
      const searchTerm = document
        .getElementById("searchInput")
        .value.toLowerCase();

      const filtered = allUsers.filter((user) => {
        const matchesRole = !roleFilter || user.role === roleFilter;
        const matchesSearch =
          !searchTerm ||
          user.first_name?.toLowerCase().includes(searchTerm) ||
          user.last_name?.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm);

        return matchesRole && matchesSearch;
      });

      displayUsers(filtered);
    }

    let currentEditUserId = null;

    function openEditModal(userId) {
      const user = allUsers.find((u) => u.id === userId);
      if (!user) return;

      currentEditUserId = userId;
      document.getElementById("editFirstName").value = user.first_name || "";
      document.getElementById("editLastName").value = user.last_name || "";
      document.getElementById("editEmail").value = user.email;
      document.getElementById("editPhone").value = user.mobile_phone || "";
      document.getElementById("editRole").value = user.role;
      document.getElementById("editCity").value = user.city || "";
      document.getElementById("editState").value = user.state_province || "";
      document.getElementById("editCountry").value = user.country || "";
      document.getElementById("editVerified").checked = user.is_verified;

      document.getElementById("editModal").style.display = "flex";
    }

    function openDeleteModal(userId, email) {
      currentEditUserId = userId;
      document.getElementById("deleteUserEmail").textContent = email;
      document.getElementById("deleteModal").style.display = "flex";
    }

    function openViewModal(userId) {
      const user = allUsers.find((u) => u.id === userId);
      if (!user) return;

      document.getElementById("viewUserId").textContent = user.id;
      document.getElementById("viewUserEmail").textContent = user.email;
      document.getElementById("viewUserFirstName").textContent = user.first_name || "‚Äî";
      document.getElementById("viewUserLastName").textContent = user.last_name || "‚Äî";
      document.getElementById("viewUserMobilePhone").textContent = user.mobile_phone || "‚Äî";
      document.getElementById("viewUserLandlinePhone").textContent = user.landline_phone || "‚Äî";
      document.getElementById("viewUserCity").textContent = user.city || "‚Äî";
      document.getElementById("viewUserState").textContent = user.state_province || "‚Äî";
      document.getElementById("viewUserCountry").textContent = user.country || "‚Äî";
      document.getElementById("viewUserAddress").textContent = user.address || "‚Äî";
      document.getElementById("viewUserTaxId").textContent = user.tax_id || "‚Äî";
      document.getElementById("viewUserRole").textContent = user.role || "‚Äî";
      document.getElementById("viewUserVerified").textContent = user.is_verified ? "‚úì Verificado" : "Sin verificar";
      document.getElementById("viewUserCaficultorStatus").textContent = user.caficultor_status || "none";
      document.getElementById("viewUserCreatedAt").textContent = user.created_at 
        ? new Date(user.created_at).toLocaleDateString("es-ES", { year: 'numeric', month: 'long', day: 'numeric' })
        : "‚Äî";
      document.getElementById("viewUserLastLogin").textContent = user.last_login_at
        ? new Date(user.last_login_at).toLocaleDateString("es-ES", { year: 'numeric', month: 'long', day: 'numeric' })
        : "Nunca";

      document.getElementById("viewModal").style.display = "flex";
    }

    async function confirmDelete() {
      if (!currentEditUserId) return;

      try {
        const response = await fetch(`/api/users/${currentEditUserId}`, {
          method: "DELETE",
          credentials: "include",
        });

        if (!response.ok) {
          const data = await response.json();
          alert("Error: " + (data.error || "No se pudo eliminar el usuario"));
          return;
        }

        alert("Usuario eliminado exitosamente");
        document.getElementById("deleteModal").style.display = "none";
        loadUsers();
      } catch (err) {
        console.error("Error:", err);
        alert("Error al eliminar el usuario");
      }
    }

    document
      .getElementById("editForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentEditUserId) return;

        const userData = {
          first_name: document.getElementById("editFirstName").value,
          last_name: document.getElementById("editLastName").value,
          mobile_phone: document.getElementById("editPhone").value,
          city: document.getElementById("editCity").value,
          state_province: document.getElementById("editState").value,
          country: document.getElementById("editCountry").value,
          role: document.getElementById("editRole").value,
          is_verified: document.getElementById("editVerified").checked ? 1 : 0,
        };

        try {
          const response = await fetch(`/api/users/${currentEditUserId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(userData),
          });

          if (!response.ok) {
            const data = await response.json();
            alert(
              "Error: " + (data.error || "No se pudo actualizar el usuario")
            );
            return;
          }

          alert("Usuario actualizado exitosamente");
          document.getElementById("editModal").style.display = "none";
          loadUsers();
        } catch (err) {
          console.error("Error:", err);
          alert("Error al actualizar el usuario");
        }
      });

    // Cerrar modales al hacer clic fuera
    document.getElementById("editModal").addEventListener("click", (e) => {
      if (e.target.id === "editModal") {
        e.target.style.display = "none";
      }
    });

    document.getElementById("deleteModal").addEventListener("click", (e) => {
      if (e.target.id === "deleteModal") {
        e.target.style.display = "none";
      }
    });

    // Event listeners para botones de editar y eliminar
    function attachButtonListeners() {
      document.querySelectorAll(".editBtn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const userId = parseInt(e.target.dataset.userId);
          openEditModal(userId);
        });
      });

      document.querySelectorAll(".deleteBtn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const userId = parseInt(e.target.dataset.userId);
          const email = e.target.dataset.userEmail;
          openDeleteModal(userId, email);
        });
      });
    }

    // Llamar despu√©s de mostrar la tabla
    const originalDisplayUsers = displayUsers;
    displayUsers = function (users) {
      originalDisplayUsers(users);
      attachButtonListeners();
    };

    // Event listeners
    document
      .getElementById("roleFilter")
      .addEventListener("change", filterUsers);
    document
      .getElementById("searchInput")
      .addEventListener("input", filterUsers);

    // Cargar usuarios al inicio
    loadUsers();
  </script>
</AppLayout>

---
import MobileLayout from "../../layouts/MobileLayout.astro";
---

<MobileLayout title="Recoger del Tueste" description="Registra los caf√©s tostados con su nivel de tueste y nuevo peso">
  <form id="roastRetrievalForm">
    <!-- Selecci√≥n de Lote en Tosti√≥n -->
    <div class="form-group">
      <label for="roastingLotSelect">Lote en Proceso de Tosti√≥n <span class="required">*</span></label>
      <select id="roastingLotSelect" name="roastingLot" required>
        <option value="">Selecciona un lote...</option>
      </select>
      <div class="form-hint">Lotes que est√°n siendo procesados</div>
    </div>

    <!-- Info del Lote -->
    <div class="card" id="roastingInfoCard" style="display: none;">
      <h3>Informaci√≥n de Tosti√≥n</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.95rem;">
        <div>
          <div style="color: #666; font-size: 0.85rem;">Lote ID</div>
          <div style="font-weight: 600;" id="roastingLotId">‚Äî</div>
        </div>
        <div>
          <div style="color: #666; font-size: 0.85rem;">Variedad</div>
          <div style="font-weight: 600;" id="roastingVariety">‚Äî</div>
        </div>
        <div>
          <div style="color: #666; font-size: 0.85rem;">Peso Enviado</div>
          <div style="font-weight: 600;" id="roastingWeightSent">‚Äî</div>
        </div>
        <div>
          <div style="color: #666; font-size: 0.85rem;">Temp. Target</div>
          <div style="font-weight: 600;" id="roastingTargetTemp">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Nivel de Tosti√≥n -->
    <div class="form-group">
      <label>Nivel de Tosti√≥n <span class="required">*</span></label>
      <div class="radio-group">
        <label class="radio-item">
          <input type="radio" name="roastLevel" value="LIGHT" required />
          <span>‚òï Tosti√≥n Clara (Light)</span>
        </label>
        <label class="radio-item">
          <input type="radio" name="roastLevel" value="MEDIUM" required />
          <span>‚òï‚òï Tosti√≥n Media (Medium)</span>
        </label>
        <label class="radio-item">
          <input type="radio" name="roastLevel" value="DARK" required />
          <span>‚òï‚òï‚òï Tosti√≥n Oscura (Dark)</span>
        </label>
      </div>
      <div class="form-hint">Selecciona seg√∫n el color y aroma del caf√© tostado</div>
    </div>

    <!-- Nuevo Peso Neto -->
    <div class="form-group">
      <label for="roastedWeight">Peso Neto de Caf√© Tostado <span class="required">*</span></label>
      <div style="display: flex; gap: 0.5rem;">
        <input
          type="number"
          id="roastedWeight"
          name="roastedWeight"
          placeholder="Ej: 38.5"
          step="0.1"
          min="0"
          required
          style="flex: 1;"
        />
        <div style="display: flex; align-items: center; padding: 0 0.75rem; background: #f5f5f5; border-radius: 0.375rem; border: 1px solid #e6e6e6; min-width: 60px;">
          kg
        </div>
      </div>
      <div class="form-hint">Peso despu√©s del tueste (generalmente menor por p√©rdida de humedad)</div>
    </div>

    <!-- C√°lculo de P√©rdida de Peso -->
    <div class="info-box" id="weightLossBox" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>P√©rdida de Peso:</strong>
          <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">Humedad evaporada durante el tueste</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 1.4rem; font-weight: bold; color: #c67b4e;" id="weightLossPercent">‚Äî</div>
          <div style="font-size: 0.85rem; color: #666;">(<span id="weightLossAmount">‚Äî</span> kg)</div>
        </div>
      </div>
    </div>

    <!-- Temperatura Alcanzada -->
    <div class="form-group">
      <label for="actualTemp">Temperatura Alcanzada (¬∞C)</label>
      <input
        type="number"
        id="actualTemp"
        name="actualTemp"
        placeholder="Ej: 208"
        step="1"
        min="180"
        max="230"
      />
      <div class="form-hint">Temperatura m√°xima registrada durante el tueste</div>
    </div>

    <!-- Tiempo de Tueste -->
    <div class="form-group">
      <label for="roastTime">Tiempo de Tueste (minutos)</label>
      <input
        type="number"
        id="roastTime"
        name="roastTime"
        placeholder="Ej: 12"
        step="0.5"
        min="0"
      />
      <div class="form-hint">Duraci√≥n total del proceso de tosti√≥n</div>
    </div>

    <!-- Observaciones -->
    <div class="form-group">
      <label for="observations">Observaciones (Opcional)</label>
      <textarea
        id="observations"
        name="observations"
        placeholder="Ej: Desarrollo uniforme, crackle completo, aroma con notas de chocolate..."
      ></textarea>
    </div>

    <!-- Resumen -->
    <div class="info-box" id="summaryBox" style="display: none;">
      <strong>Resumen del Caf√© Tostado:</strong>
      <div style="margin-top: 0.75rem; font-size: 0.95rem; line-height: 1.6;">
        <div>üì¶ Lote: <span id="summaryLot" style="font-weight: 600;">‚Äî</span></div>
        <div>‚òï Nivel: <span id="summaryLevel" style="font-weight: 600;">‚Äî</span></div>
        <div>‚öñÔ∏è Peso Tostado: <span id="summaryWeight" style="font-weight: 600;">‚Äî</span></div>
        <div>üìä P√©rdida: <span id="summaryLoss" style="font-weight: 600;">‚Äî</span></div>
      </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="form-actions" style="margin-bottom: 2rem;">
      <button type="reset" class="btn-secondary">Limpiar</button>
      <button type="submit" class="btn-primary">Registrar Tueste</button>
    </div>
  </form>

  <script>
    const roastingLotSelect = document.getElementById("roastingLotSelect");
    const roastedWeightInput = document.getElementById("roastedWeight");
    const form = document.getElementById("roastRetrievalForm");
    const summaryBox = document.getElementById("summaryBox");
    const roastingInfoCard = document.getElementById("roastingInfoCard");
    const weightLossBox = document.getElementById("weightLossBox");

    let currentRoastingRecord = null;

    // Cargar lotes en tosti√≥n
    function loadRoastingLots() {
      const roasting = JSON.parse(localStorage.getItem("roasting") || "[]");
      const inProcess = roasting.filter((r) => r.status === "in_roasting");

      roastingLotSelect.innerHTML = '<option value="">Selecciona un lote...</option>';
      inProcess.forEach((record) => {
        const option = document.createElement("option");
        option.value = JSON.stringify(record);
        option.textContent = `${record.originalLotId} (${record.quantitySent} ${record.weightUnit})`;
        roastingLotSelect.appendChild(option);
      });
    }

    // Actualizar informaci√≥n del lote
    roastingLotSelect.addEventListener("change", () => {
      if (!roastingLotSelect.value) {
        roastingInfoCard.style.display = "none";
        summaryBox.style.display = "none";
        return;
      }

      currentRoastingRecord = JSON.parse(roastingLotSelect.value);
      document.getElementById("roastingLotId").textContent = currentRoastingRecord.originalLotId;
      document.getElementById("roastingVariety").textContent = currentRoastingRecord.harvest.variety;
      document.getElementById("roastingWeightSent").textContent = `${currentRoastingRecord.quantitySent} ${currentRoastingRecord.weightUnit}`;
      document.getElementById("roastingTargetTemp").textContent = currentRoastingRecord.targetTemp ? `${currentRoastingRecord.targetTemp}¬∞C` : "No especificada";

      roastingInfoCard.style.display = "block";
      roastedWeightInput.max = currentRoastingRecord.quantitySent * 0.95; // M√°ximo 95% (considerando p√©rdida m√≠nima)
      updateSummary();
    });

    // Calcular p√©rdida de peso
    roastedWeightInput.addEventListener("input", () => {
      if (!currentRoastingRecord || !roastedWeightInput.value) {
        weightLossBox.style.display = "none";
        return;
      }

      const original = currentRoastingRecord.quantitySent;
      const roasted = parseFloat(roastedWeightInput.value);
      const loss = original - roasted;
      const lossPercent = ((loss / original) * 100).toFixed(1);

      document.getElementById("weightLossAmount").textContent = loss.toFixed(2);
      document.getElementById("weightLossPercent").textContent = `${lossPercent}%`;
      weightLossBox.style.display = "block";

      updateSummary();
    });

    // Actualizar resumen
    function updateSummary() {
      const roastLevel = document.querySelector('input[name="roastLevel"]:checked')?.value || "";
      const roastedWeight = roastedWeightInput.value;

      if (roastLevel && roastedWeight && currentRoastingRecord) {
        const original = currentRoastingRecord.quantitySent;
        const roasted = parseFloat(roastedWeight);
        const loss = original - roasted;
        const lossPercent = ((loss / original) * 100).toFixed(1);

        document.getElementById("summaryLot").textContent = currentRoastingRecord.originalLotId;
        document.getElementById("summaryLevel").textContent = roastLevel === "LIGHT" ? "Clara" : roastLevel === "MEDIUM" ? "Media" : "Oscura";
        document.getElementById("summaryWeight").textContent = `${roasted} kg`;
        document.getElementById("summaryLoss").textContent = `${lossPercent}% (${loss.toFixed(2)} kg)`;
        summaryBox.style.display = "block";
      } else {
        summaryBox.style.display = "none";
      }
    }

    document.querySelectorAll('input[name="roastLevel"]').forEach((radio) => {
      radio.addEventListener("change", updateSummary);
    });

    // Enviar formulario
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      if (!currentRoastingRecord) {
        alert("‚ö†Ô∏è Debes seleccionar un lote");
        return;
      }

      const roastLevel = document.querySelector('input[name="roastLevel"]:checked').value;
      const roastedWeight = parseFloat(roastedWeightInput.value);

      if (roastedWeight <= 0 || roastedWeight > currentRoastingRecord.quantitySent) {
        alert("‚ö†Ô∏è El peso debe ser mayor a 0 y no exceder el peso enviado");
        return;
      }

      const roastRecord = {
        id: `ROASTED-${Date.now()}`,
        roastingRecordId: currentRoastingRecord.id,
        originalLotId: currentRoastingRecord.originalLotId,
        quantitySent: currentRoastingRecord.quantitySent,
        quantityRoasted: roastedWeight,
        roastLevel: roastLevel,
        actualTemp: document.getElementById("actualTemp").value || null,
        roastTime: document.getElementById("roastTime").value || null,
        observations: document.getElementById("observations").value,
        weightUnit: currentRoastingRecord.weightUnit,
        roastedAt: new Date().toISOString(),
        status: "ready_for_storage",
        harvest: currentRoastingRecord.harvest,
      };

      // Actualizar estado del registro de tosti√≥n
      const roasting = JSON.parse(localStorage.getItem("roasting") || "[]");
      const index = roasting.findIndex((r) => r.id === currentRoastingRecord.id);
      if (index !== -1) {
        roasting[index].status = "completed";
      }
      localStorage.setItem("roasting", JSON.stringify(roasting));

      // Guardar registro de caf√© tostado
      const roasted = JSON.parse(localStorage.getItem("roasted") || "[]");
      roasted.push(roastRecord);
      localStorage.setItem("roasted", JSON.stringify(roasted));

      alert(`‚úÖ Tueste registrado correctamente\n${roastRecord.quantityRoasted} kg de caf√© ${roastRecord.roastLevel === "LIGHT" ? "claro" : roastRecord.roastLevel === "MEDIUM" ? "medio" : "oscuro"}`);

      form.reset();
      roastingInfoCard.style.display = "none";
      summaryBox.style.display = "none";
      weightLossBox.style.display = "none";
      loadRoastingLots();
    });

    // Cargar lotes al iniciar
    loadRoastingLots();
  </script>
</MobileLayout>

---
import Layout from "../../layouts/Layout.astro";
import CoffeeDetail from "../../components/CoffeeDetail.jsx";
import AccessoryDetail from "../../components/AccessoryDetail.jsx";
import { products } from "../../data/products.ts";

// Import CSS
import "../../../public/assets/css/product-detail.css";

// Configuración de renderizado
export const prerender = false; // Habilitar SSR para consultas a BD

export async function getStaticPaths() {
  return products.map((product) => ({
    params: { slug: product.id },
    props: { product },
  }));
}

const { slug } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000/api";

let product = null;
let coffeeProfile = null;
let accessoryDetails = null;

try {
  // Intentar obtener producto de la BD
  const response = await fetch(`${API_URL}/inventory/products/${slug}`, {
    headers: {
      "Content-Type": "application/json",
      // TODO: Agregar token de autenticación si es necesario
    },
  });

  if (response.ok) {
    const data = await response.json();
    if (data.success) {
      product = data.product;

      // Si el producto es café, buscar información del lote asociado
      if (product.category === "cafe" && product.id) {
        try {
          const lotResponse = await fetch(
            `${API_URL}/lots?product_id=${product.id}`,
            {
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (lotResponse.ok) {
            const lotData = await lotResponse.json();
            if (lotData.lots && lotData.lots.length > 0) {
              const lot = lotData.lots[0]; // Tomar el primer lote

              // Construir perfil de taza desde la BD
              coffeeProfile = {
                aroma: lot.aroma || "Notas aromáticas características",
                flavorNotes: lot.flavor_notes || "Perfil de sabor único",
                acidity: lot.acidity || "Acidez balanceada",
                body: lot.body || "Cuerpo medio",
                balance: lot.balance || "Equilibrado",
                score: lot.score || product.rating * 20,
                altitude: lot.altitude || "Alta montaña",
                variety: lot.variety || "Variedad especial",
                farm: lot.farm || "Finca productora",
                producer: lot.producer || "Productor local",
                process:
                  lot.process || product.process || "Procesamiento especial",
                roast: lot.roast || product.roast || "Tueste artesanal",
              };
            }
          }
        } catch (lotError) {
          console.error("Error fetching lot data:", lotError);
        }
      }
    }
  }
} catch (error) {
  console.error("Error fetching product from API:", error);
}

// Fallback: Si no se pudo obtener de la BD, usar datos estáticos
if (!product) {
  product = products.find((p) => p.id === slug);
  if (!product) {
    return Astro.redirect("/404");
  }
}

const isCoffee = product.category === "Cafés" || product.category === "cafe";

// Si no se obtuvo perfil de café de la BD, usar datos por defecto
if (isCoffee && !coffeeProfile) {
  coffeeProfile = {
    aroma:
      product.id === "cf-sierra"
        ? "Floral, cítrico"
        : product.id === "cf-huila"
          ? "Frutal, caramelo"
          : "Chocolate, nuez",
    flavorNotes:
      product.id === "cf-sierra"
        ? "Naranja, jazmín, panela"
        : product.id === "cf-huila"
          ? "Frutas rojas, miel, durazno"
          : "Chocolate oscuro, caramelo, almendra",
    acidity:
      product.id === "cf-sierra"
        ? "Alta, brillante"
        : product.id === "cf-huila"
          ? "Media-alta, dulce"
          : "Baja, suave",
    body:
      product.id === "cf-sierra"
        ? "Medio, sedoso"
        : product.id === "cf-huila"
          ? "Medio-alto, cremoso"
          : "Alto, intenso",
    balance: "Excelente",
    score: product.rating * 20,
    altitude:
      product.origin === "Sierra Nevada"
        ? "1600-2000 msnm"
        : product.origin === "Huila"
          ? "1500-1900 msnm"
          : "1700-2100 msnm",
    variety:
      product.id === "cf-sierra"
        ? "Caturra, Castillo"
        : product.id === "cf-huila"
          ? "Caturra, Colombia"
          : "Típica, Caturra",
    farm:
      product.id === "cf-sierra"
        ? "Finca La Esperanza"
        : product.id === "cf-huila"
          ? "Finca El Paraíso"
          : "Finca Los Alpes",
    producer:
      product.id === "cf-sierra"
        ? "José Martínez"
        : product.id === "cf-huila"
          ? "María Rodríguez"
          : "Carlos López",
  };
}

// Para accesorios, datos adicionales desde BD o fallback
const accessoryDetails = !isCoffee
  ? {
      brand: product.id === "acc-molinillo" ? "Hario" : "Chemex",
      material:
        product.id === "acc-molinillo"
          ? "Acero inoxidable, cerámica"
          : "Vidrio borosilicato, madera",
      dimensions:
        product.id === "acc-molinillo" ? "15 x 10 x 20 cm" : "20 x 13 x 23 cm",
      weight: product.id === "acc-molinillo" ? "450g" : "680g",
      capacity: product.id === "acc-chemex" ? "6 tazas (900ml)" : null,
      features:
        product.id === "acc-molinillo"
          ? [
              "Molido ajustable de fino a grueso",
              "Muelas de cerámica para mayor durabilidad",
              "Capacidad de 30g de café",
              "Fácil limpieza",
              "Diseño ergonómico",
            ]
          : [
              "Vidrio resistente al calor",
              "Collar de madera natural",
              "Filtros de papel incluidos (100 unidades)",
              "Diseño icónico",
              "Fácil de limpiar",
            ],
      inBox:
        product.id === "acc-molinillo"
          ? [
              "1 Molinillo manual",
              "Cepillo de limpieza",
              "Manual de instrucciones",
            ]
          : [
              "1 Chemex 6 tazas",
              "100 filtros de papel",
              "Manual de preparación",
            ],
    }
  : null;
---

<Layout title={`${product.name} - DobleYo`}>
  <div class="product-detail-page">
    {
      isCoffee ? (
        <CoffeeDetail client:load product={product} profile={coffeeProfile} />
      ) : (
        <AccessoryDetail
          client:load
          product={product}
          details={accessoryDetails}
        />
      )
    }
  </div>
</Layout>

<style>
  .product-detail-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8f4ed 0%, #faf7f2 100%);
  }
</style>

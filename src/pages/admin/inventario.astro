---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout>
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-900">Gesti√≥n de Inventario</h1>
    <button onclick="loadInventory()" class="text-sm text-amber-700 hover:text-amber-900 font-medium flex items-center gap-1">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.051M20.418 20.418A9.969 9.969 0 0112 22c-5.523 0-10-4.477-10-10S6.477 2 12 2s10 4.477 10 10a9.953 9.953 0 01-1.793 5.739M15 11l-3 3m0 0l-3-3m3 3V8" />
      </svg>
      Refrescar
    </button>
  </div>

  <div id="loading" class="text-center py-12">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-900 mx-auto mb-4"></div>
    <p class="text-gray-500">Cargando inventario...</p>
  </div>

  <div id="error" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

  <div id="inventoryTable" class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold">
            <th class="px-6 py-4">Producto</th>
            <th class="px-6 py-4">SKU</th>
            <th class="px-6 py-4">Precio</th>
            <th class="px-6 py-4">Stock Actual</th>
            <th class="px-6 py-4">Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-gray-100">
          <!-- Rows will be injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <script is:inline>
    const API_URL = "/api/stock";

    // Elements
    const tableBody = document.getElementById("tableBody");
    const loadingEl = document.getElementById("loading");
    const tableEl = document.getElementById("inventoryTable");
    const errorEl = document.getElementById("error");

    // Initial Load
    loadInventory();

    async function loadInventory() {
      if(loadingEl) loadingEl.style.display = "block";
      if(tableEl) tableEl.style.display = "none";
      
      try {
        const res = await fetch(API_URL, {
          credentials: "include",
        });
        if (!res.ok) throw new Error("Error cargando inventario");
        const data = await res.json();
        renderTable(data.items);
        if(loadingEl) loadingEl.style.display = "none";
        if(tableEl) tableEl.style.display = "block";
      } catch (err) {
        showError(err.message);
        if(loadingEl) loadingEl.style.display = "none";
      }
    }

    function renderTable(items) {
      if (!tableBody) return;
      tableBody.innerHTML = items
        .map(
          (item) => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <img src="${item.image_url}" alt="${item.name}" class="w-10 h-10 rounded object-cover bg-gray-100">
              <span class="font-medium text-gray-900">${item.name}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 font-mono">${item.slug}</td>
          <td class="px-6 py-4 text-sm text-gray-900 font-medium">$${(item.price_cop || 0).toLocaleString("es-CO")}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
              item.stock < 10 ? "bg-red-100 text-red-800" : "bg-green-100 text-green-800"
            }">
              ${item.stock} unidades
            </span>
          </td>
          <td class="px-6 py-4">
            <form class="update-stock-form flex items-center gap-2" data-sku="${item.slug}">
              <input 
                type="number" 
                name="stock" 
                value="${item.stock}" 
                min="0" 
                class="w-20 px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-amber-500 focus:border-amber-500" 
                required
              >
              <button 
                type="submit" 
                class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors"
              >
                Actualizar
              </button>
            </form>
          </td>
        </tr>
      `
        )
        .join("");

      // Attach event listeners to forms
      document.querySelectorAll(".update-stock-form").forEach((form) => {
        form.addEventListener("submit", handleUpdateStock);
      });
    }

    async function handleUpdateStock(e) {
      e.preventDefault();
      const form = e.target;
      const sku = form.dataset.sku;
      const stock = form.stock.value;
      const btn = form.querySelector("button");

      const originalText = btn.textContent;
      btn.textContent = "...";
      btn.disabled = true;

      try {
        const res = await fetch(`${API_URL}/${sku}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ stock: parseInt(stock) }),
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || "Error actualizando stock");
        }

        // Success feedback
        btn.textContent = "OK";
        btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        btn.classList.add('bg-green-600', 'text-white', 'border-transparent');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
          btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
          btn.classList.remove('bg-green-600', 'text-white', 'border-transparent');
          loadInventory(); // Reload to refresh table state
        }, 1500);
      } catch (err) {
        alert(err.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    function showError(msg) {
      if (errorEl) {
        errorEl.textContent = msg;
        errorEl.style.display = "block";
      }
    }
  </script>
</AdminLayout>
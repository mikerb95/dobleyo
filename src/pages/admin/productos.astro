---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout>
  <div class="mb-4">
    <h1 class="text-xl font-bold text-gray-900">Gestión de Productos</h1>
    <p class="text-xs text-gray-500">
      Administra el catálogo de productos y precios.
    </p>
  </div>

  <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4">
    <nav class="-mb-px flex space-x-4">
      <button
        class="tab-btn active border-amber-500 text-amber-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs"
        data-tab="crear"
      >
        Crear Producto
      </button>
      <button
        class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs"
        data-tab="lista"
      >
        Listar Productos
      </button>
    </nav>
  </div>

  <!-- Tab: Crear Producto -->
  <div id="crear-tab" class="tab-content">
    <div
      class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 max-w-2xl"
    >
      <h2 class="text-base font-semibold text-gray-900 mb-4">Nuevo Producto</h2>

      <form id="productForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >ID del Producto (SKU)</label
            >
            <input
              type="text"
              id="productId"
              required
              placeholder="ej: cafe-colombia-1kg"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Nombre</label
            >
            <input
              type="text"
              id="productName"
              required
              placeholder="ej: Café Colombia 1kg"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Precio (COP)</label
            >
            <input
              type="number"
              id="productPrice"
              required
              placeholder="ej: 25000"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Stock Inicial</label
            >
            <input
              type="number"
              id="productStock"
              value="0"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Categoría</label
            >
            <input
              type="text"
              id="productCategory"
              placeholder="ej: cafe-molido"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Origen</label
            >
            <input
              type="text"
              id="productOrigin"
              placeholder="ej: Huila, Colombia"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"
            />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Proceso</label
            >
            <input
              type="text"
              id="productProcess"
              placeholder="ej: Washed"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Tueste</label
            >
            <input
              type="text"
              id="productRoast"
              placeholder="ej: Medium"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >URL de Imagen</label
          >
          <input
            type="url"
            id="productImage"
            placeholder="https://..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
          />
        </div>

        <div class="pt-3">
          <button
            type="submit"
            id="submitBtn"
            class="w-full flex justify-center py-2 px-3 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-amber-900 hover:bg-amber-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-colors"
          >
            Crear Producto
          </button>
        </div>
      </form>

      <div
        id="formError"
        class="hidden mt-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-xs"
      >
      </div>
      <div
        id="formSuccess"
        class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-xs"
      >
      </div>
    </div>
  </div>

  <!-- Tab: Listar Productos -->
  <div id="lista-tab" class="tab-content hidden">
    <div id="loading" class="text-center py-8">
      <div
        class="animate-spin rounded-full h-6 w-6 border-b-2 border-amber-900 mx-auto mb-3"
      >
      </div>
      <p class="text-xs text-gray-500">Cargando productos...</p>
    </div>

    <div
      id="productsList"
      class="hidden bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden"
    >
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse text-sm">
          <thead>
            <tr
              class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold"
            >
              <th class="px-4 py-3">ID</th>
              <th class="px-4 py-3">Nombre</th>
              <th class="px-4 py-3">Precio</th>
              <th class="px-4 py-3">Stock</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-100">
            <!-- Rows injected here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script is:inline>
    // Tab management
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const tabName = btn.dataset.tab;

        // Hide all tabs
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.add("hidden"));
        document.querySelectorAll(".tab-btn").forEach((el) => {
          el.classList.remove("active", "border-amber-500", "text-amber-600");
          el.classList.add(
            "border-transparent",
            "text-gray-500",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
        });

        // Show selected tab
        document.getElementById(tabName + "-tab").classList.remove("hidden");
        btn.classList.add("active", "border-amber-500", "text-amber-600");
        btn.classList.remove(
          "border-transparent",
          "text-gray-500",
          "hover:text-gray-700",
          "hover:border-gray-300"
        );

        // Load products if lista tab
        if (tabName === "lista") {
          loadProducts();
        }
      });
    });

    // Form submission
    document
      .getElementById("productForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const formError = document.getElementById("formError");
        const formSuccess = document.getElementById("formSuccess");
        const submitBtn = document.getElementById("submitBtn");

        const data = {
          id: document.getElementById("productId").value.trim(),
          name: document.getElementById("productName").value.trim(),
          price: parseInt(document.getElementById("productPrice").value),
          stock: parseInt(document.getElementById("productStock").value) || 0,
          category:
            document.getElementById("productCategory").value.trim() || null,
          origin: document.getElementById("productOrigin").value.trim() || null,
          process:
            document.getElementById("productProcess").value.trim() || null,
          roast: document.getElementById("productRoast").value.trim() || null,
          image_url:
            document.getElementById("productImage").value.trim() || null,
        };

        if (!data.id || !data.name || !data.price) {
          formError.textContent = "ID, Nombre y Precio son requeridos";
          formError.classList.remove("hidden");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Creando...";
        formError.classList.add("hidden");
        formSuccess.classList.add("hidden");

        try {
          const res = await fetch("/api/stock", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(data),
          });

          const result = await res.json();

          if (!res.ok) {
            throw new Error(result.error || "Error creando producto");
          }

          formSuccess.textContent = `✓ Producto "${result.name}" creado exitosamente`;
          formSuccess.classList.remove("hidden");

          // Reset form
          document.getElementById("productForm").reset();

          setTimeout(() => {
            formSuccess.classList.add("hidden");
          }, 3000);
        } catch (err) {
          formError.textContent = err.message;
          formError.classList.remove("hidden");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Crear Producto";
        }
      });

    // Load and display products
    async function loadProducts() {
      const loading = document.getElementById("loading");
      const productsList = document.getElementById("productsList");
      const tableBody = document.getElementById("tableBody");

      try {
        const res = await fetch("/api/stock", {
          credentials: "include",
        });

        if (!res.ok) throw new Error("Error cargando productos");

        const data = await res.json();

        if (!data.items || data.items.length === 0) {
          loading.innerHTML =
            '<p class="text-gray-500">No hay productos registrados.</p>';
          return;
        }

        tableBody.innerHTML = data.items
          .map(
            (p) => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-mono text-sm text-gray-600">${p.slug || "—"}</td>
            <td class="px-6 py-4 font-medium text-gray-900">${p.name || "—"}</td>
            <td class="px-6 py-4 text-gray-900">$${p.price_cop?.toLocaleString() || "—"}</td>
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                (p.stock || 0) < 10
                  ? "bg-red-100 text-red-800"
                  : "bg-green-100 text-green-800"
              }">
                ${p.stock || 0}
              </span>
            </td>
          </tr>
        `
          )
          .join("");

        loading.style.display = "none";
        productsList.classList.remove("hidden");
      } catch (err) {
        loading.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
      }
    }
  </script>
</AdminLayout>

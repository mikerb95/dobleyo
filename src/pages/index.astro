---
import Layout from "../layouts/Layout.astro";
---

<!-- Redirecci√≥n autom√°tica a m√≥vil si es necesario -->
<script is:inline>
  // Detectar si es dispositivo m√≥vil y redirigir
  if (typeof window !== "undefined") {
    const isMobile =
      /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      ) || window.innerWidth < 768;

    // Solo redirigir si estamos en la ra√≠z y es m√≥vil
    if (isMobile && window.location.pathname === "/") {
      // Guardar preferencia para no redirigir constantemente si el usuario vuelve
      const skipMobile = sessionStorage.getItem("skipMobileRedirect");
      if (!skipMobile) {
        window.location.href = "/mobile";
      }
    }
  }
</script>

<Layout>
  <section class="hero">
    <div class="hero-media" aria-hidden="true">
      <video
        src="/assets/vids/hero.mp4"
        autoplay
        muted
        loop
        playsinline
        disablePictureInPicture
        preload="metadata"></video>
    </div>
    <!-- Overlay para mejorar legibilidad del texto sobre el video -->
    <div class="hero-overlay" aria-hidden="true"></div>
    <h1>M√°s que caf√©, una herencia en cada taza.</h1>
    <p>
      Somos el reflejo de la riqueza cultural y el esfuerzo de generaciones que
      cultivan en el coraz√≥n de Colombia. Descubre el sabor de nuestra tradici√≥n
      y la pasi√≥n de nuestra tierra.
    </p>
    <p><a class="btn" href="/tienda" data-link>Ver tienda</a></p>
  </section>

  <!-- Seccion de cafes en venta -->
  <section class="coffee-shop" aria-labelledby="coffeeShopTitle">
    <div class="coffee-shop-header">
      <h2 id="coffeeShopTitle" class="coffee-shop-title">Caf√©s en venta</h2>
      <a href="/tienda" class="coffee-shop-link" data-link>Ver todos ‚Üí</a>
    </div>

    <div class="coffee-scroll">
      <!-- Caf√© 1 -->
      <article class="coffee-card">
        <img
          src="https://images.unsplash.com/photo-1512568400610-62da28bc8a13?q=80&w=400&auto=format&fit=crop"
          alt="Caf√© Sierra Nevada"
          class="coffee-img"
          loading="lazy"
        />
        <span class="coffee-badge">Tueste Medio</span>
        <h3 class="coffee-name">Sierra Nevada</h3>
        <p class="coffee-notes">Cacao, Nuez, Caramelo</p>
        <div class="coffee-footer">
          <span class="coffee-price">$42.000</span>
          <button class="btn-add" aria-label="Agregar al carrito">+</button>
        </div>
      </article>

      <!-- Caf√© 2 -->
      <article class="coffee-card">
        <img
          src="https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=400&auto=format&fit=crop"
          alt="Caf√© Huila"
          class="coffee-img"
          loading="lazy"
        />
        <span class="coffee-badge">Tueste Claro</span>
        <h3 class="coffee-name">Huila</h3>
        <p class="coffee-notes">C√≠tricos, Miel, Floral</p>
        <div class="coffee-footer">
          <span class="coffee-price">$45.000</span>
          <button class="btn-add" aria-label="Agregar al carrito">+</button>
        </div>
      </article>

      <!-- Caf√© 3 -->
      <article class="coffee-card">
        <img
          src="https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=400&auto=format&fit=crop"
          alt="Caf√© Nari√±o"
          class="coffee-img"
          loading="lazy"
        />
        <span class="coffee-badge">Tueste Medio</span>
        <h3 class="coffee-name">Nari√±o</h3>
        <p class="coffee-notes">Frutas Rojas, Chocolate</p>
        <div class="coffee-footer">
          <span class="coffee-price">$48.000</span>
          <button class="btn-add" aria-label="Agregar al carrito">+</button>
        </div>
      </article>

      <!-- Caf√© 4 -->
      <article class="coffee-card">
        <img
          src="https://images.unsplash.com/photo-1447933601403-0c6688de566e?q=80&w=400&auto=format&fit=crop"
          alt="Caf√© Antioquia"
          class="coffee-img"
          loading="lazy"
        />
        <span class="coffee-badge best-seller">M√°s Vendido</span>
        <h3 class="coffee-name">Antioquia</h3>
        <p class="coffee-notes">Panela, Nuez, Dulce</p>
        <div class="coffee-footer">
          <span class="coffee-price">$44.000</span>
          <button class="btn-add" aria-label="Agregar al carrito">+</button>
        </div>
      </article>

      <!-- Caf√© 5 -->
      <article class="coffee-card">
        <img
          src="https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?q=80&w=400&auto=format&fit=crop"
          alt="Caf√© Cauca"
          class="coffee-img"
          loading="lazy"
        />
        <span class="coffee-badge">Tueste Oscuro</span>
        <h3 class="coffee-name">Cauca</h3>
        <p class="coffee-notes">Chocolate, Especias</p>
        <div class="coffee-footer">
          <span class="coffee-price">$46.000</span>
          <button class="btn-add" aria-label="Agregar al carrito">+</button>
        </div>
      </article>
    </div>
  </section>

  <!-- Secci√≥n de Trazabilidad -->
  <section class="traceability-section" aria-labelledby="traceabilityTitle">
    <div class="container">
      <div class="traceability-content">
        <div class="traceability-text">
          <h2 id="traceabilityTitle">Conoce el origen de tu caf√©</h2>
          <p class="traceability-subtitle">
            Cada bolsa incluye un c√≥digo QR con toda la informaci√≥n del lote
          </p>

          <div class="traceability-features">
            <div class="feature-item">
              <div class="feature-icon">üå±</div>
              <div>
                <h3>Origen Verificado</h3>
                <p>
                  Finca, regi√≥n y altura de cultivo del caf√© que est√°s
                  disfrutando
                </p>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">üë®‚Äçüåæ</div>
              <div>
                <h3>Conoce al Productor</h3>
                <p>
                  Informaci√≥n del caficultor y sus pr√°cticas de cultivo
                  sostenible
                </p>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">‚òï</div>
              <div>
                <h3>Perfil de Taza</h3>
                <p>
                  Notas de cata, m√©todo de procesamiento y recomendaciones de
                  preparaci√≥n
                </p>
              </div>
            </div>

            <div class="feature-item">
              <div class="feature-icon">üìÖ</div>
              <div>
                <h3>Fecha de Tueste</h3>
                <p>Fecha exacta de tostado para garantizar m√°xima frescura</p>
              </div>
            </div>
          </div>

          <div class="traceability-cta">
            <a href="/trazabilidad" class="btn" data-link
              >Ver ejemplo de trazabilidad</a
            >
            <p class="cta-note">
              Escanea el c√≥digo QR de tu bolsa para ver toda la informaci√≥n
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Seccion de articulos destacados -->
  <section class="featured" aria-labelledby="featuredTitle">
    <div class="featured-inner container">
      <h2 id="featuredTitle" class="featured-title">Articulos destacados</h2>
      <div class="featured-grid">
        <!-- Card 1 -->
        <article class="card featured-card">
          <img
            class="featured-img"
            src="https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?q=80&w=1200&auto=format&fit=crop"
            alt="Origen Sierra Nevada"
            loading="lazy"
          />
          <div class="p featured-body">
            <h3 class="featured-h3">Sierra Nevada: notas a cacao y caramelo</h3>
            <p class="featured-desc muted">
              Un perfil equilibrado con dulzor marcado, ideal para espresso y
              preparaciones con leche. Origen trazable y tueste fresco.
            </p>
            <a class="btn small" href="/tienda" data-link>Ver producto</a>
          </div>
        </article>
        <!-- Card 2 -->
        <article class="card featured-card">
          <img
            class="featured-img"
            src="https://images.unsplash.com/photo-1507133750040-4a8f57021524?q=80&w=1200&auto=format&fit=crop"
            alt="Guia de molienda"
            loading="lazy"
          />
          <div class="p featured-body">
            <h3 class="featured-h3">Guia rapida de molienda por metodo</h3>
            <p class="featured-desc muted">
              Mejora tu taza ajustando la molienda segun tu metodo: V60, Chemex,
              prensa o espresso. Reglas simples para resultados consistentes.
            </p>
            <a class="btn outline small" href="/blog" data-link>Leer mas</a>
          </div>
        </article>
        <!-- Card 3 -->
        <article class="card featured-card">
          <img
            class="featured-img"
            src="https://images.unsplash.com/photo-1529070538774-1843cb3265df?q=80&w=1200&auto=format&fit=crop"
            alt="Productor aliado"
            loading="lazy"
          />
          <div class="p featured-body">
            <h3 class="featured-h3">
              Productores aliados: historias de origen
            </h3>
            <p class="featured-desc muted">
              Conoce a los caficultores detras de cada lote. Transparencia,
              relaciones directas y sostenibilidad en cada paso.
            </p>
            <a class="btn outline small" href="/nosotros" data-link
              >Conocer mas</a
            >
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Seccion de evidencia (pixel perfect) -->
  <section class="evidence-section" aria-labelledby="evidenceTitle">
    <!-- Granos decorativos -->
    <img
      class="e-beans e-beans-left"
      src="/assets/beans.svg"
      alt=""
      aria-hidden="true"
    />
    <img
      class="e-beans e-beans-right"
      src="/assets/beans.svg"
      alt=""
      aria-hidden="true"
    />
    <div class="evidence-inner container">
      <div class="evidence-grid">
        <!-- Titular izquierdo -->
        <div class="e-left">
          <h2 id="evidenceTitle" class="e-title">
            A diferencia de cualquier otro caf√©
          </h2>
        </div>

        <!-- Estadisticas superiores -->
        <div class="e-stat e-stat-a">
          <div class="e-number">9 de 10</div>
          <p class="e-sub">De los compradores de DobleYo dicen que</p>
          <p class="e-sub">funciona</p>
        </div>

        <div class="e-stat e-stat-b">
          <div class="e-number">94%</div>
          <p class="e-sub">de los compradores planean</p>
          <p class="e-sub">volver a comprar</p>
        </div>

        <!-- Texto medio con insignia -->
        <div class="e-mid">
          <div
            class="e-badge"
            role="img"
            aria-label="#1 en satisfacci√≥n del consumidor"
          >
            <span class="e-badge-num">#1</span>
            <span class="e-badge-label">en Satisfacci√≥n del Consumidor</span>
          </div>
          <p class="e-desc">
            Clasificado por los compradores de DobleYo como el m√°s alto en sabor
            y eficacia frente a los compradores de productos competitivos.
          </p>
        </div>

        <!-- Lista de razones -->
        <div class="e-reasons">
          <h3 class="e-reasons-title">
            La gente se cambia a DobleYo<br class="md-break" /> por estas razones:
          </h3>
          <ol class="e-list">
            <li><span class="e-dot">1</span> Mejor sabor</li>
            <li><span class="e-dot">2</span> Mejores ingredientes</li>
            <li><span class="e-dot">3</span> Mejores resultados*</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Nuestros caf√©s</h2>
    <div class="grid" id="homeProducts"></div>
  </section>

  <script>
    // Renderizar productos desde JSON embebido (podria ser archivo externo luego)
    const productsDefault = [
      {
        id: "dbyo-sierra",
        name: "Sierra Nevada",
        price: 42000,
        image:
          "https://images.unsplash.com/photo-1512568400610-62da28bc8a13?q=80&w=800&auto=format&fit=crop",
        origin: "Sierra Nevada",
        process: "Lavado",
        roast: "Medio",
        notes: ["Cacao", "Nuez", "Caramelo"],
      },
      {
        id: "dbyo-huila",
        name: "Huila",
        price: 45000,
        image:
          "https://images.unsplash.com/photo-1509043759401-136742328bb3?q=80&w=800&auto=format&fit=crop",
        origin: "Huila",
        process: "Honey",
        roast: "Claro",
        notes: ["Panela", "Frutos rojos", "Floral"],
      },
      {
        id: "dbyo-narino",
        name: "Nari√±o",
        price: 48000,
        image:
          "https://images.unsplash.com/photo-1494415859740-21e878dd929d?q=80&w=800&auto=format&fit=crop",
        origin: "Nari√±o",
        process: "Natural",
        roast: "Oscuro",
        notes: ["C√≠tricos", "Chocolate", "Miel"],
      },
    ];
    const products = (function () {
      try {
        const x = JSON.parse(localStorage.getItem("dbyo-products") || "null");
        return Array.isArray(x) ? x : productsDefault;
      } catch {
        return productsDefault;
      }
    })();

    // Cuadricula de inicio
    const homeProducts = document.getElementById("homeProducts");
    if (homeProducts) {
      homeProducts.innerHTML = products.map((p) => cardHTML(p)).join("");
      homeProducts.addEventListener("click", (e) => {
        // @ts-ignore
        const card = e.target.closest("article.card");
        if (!card) return;
        const title = card.querySelector("h3");
        if (e.target === title) {
          const name = title.textContent;
          const p = products.find((x) => x.name === name);
          // @ts-ignore
          if (p && window.Cart) {
            window.Cart.addToCart({
              id: p.id,
              name: p.name,
              price: p.price,
              image: p.image,
              qty: 1,
            });
          }
        }
      });
    }

    function cardHTML(p) {
      return `
      <article class="card">
        <img src="${p.image}" alt="${escapeHtml(p.name)}">
        <div class="p">
          <h3>${escapeHtml(p.name)}</h3>
          <div class="muted">${p.origin} ¬∑ ${p.process} ¬∑ ${p.roast}</div>
          <div class="price">$${p.price.toLocaleString("es-CO")}</div>
        </div>
      </article>`;
    }
    function escapeHtml(str) {
      return str.replace(
        /[&<>"]+/g,
        (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" })[s]
      );
    }
  </script>
</Layout>

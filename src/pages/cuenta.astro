---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <section class="card" style="margin-top:1rem">
    <div class="p">
      <h1>Mi cuenta</h1>
      <p class="muted" id="userEmail">—</p>
      <button class="btn outline" id="logoutBtn" style="margin-top:1rem"
        >Cerrar sesión</button
      >
    </div>
  </section>

  <section class="card" style="margin-top:1rem">
    <div class="p">
      <h2>Pedidos</h2>
      <div class="muted">Aun no hay pedidos.</div>
    </div>
  </section>

  <script>
    (async function () {
      const emailEl = document.getElementById("userEmail");
      const logoutBtn = document.getElementById("logoutBtn");

      // Verificar si el usuario está logueado llamando a /api/auth/me
      try {
        const res = await fetch("/api/auth/me", {
          credentials: "include", // Importante: enviar cookies
        });

        if (!res.ok) {
          // No logueado, redirigir a login
          location.replace("/login");
          return;
        }

        const user = await res.json();
        emailEl.textContent = user.email || "—";

        // Logout
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            await fetch("/api/auth/logout", {
              method: "POST",
              credentials: "include",
            });
            location.href = "/";
          });
        }
      } catch (err) {
        console.error("Error checking auth:", err);
        location.replace("/login");
      }
    })();
  </script>
</Layout>

---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <section>
    <h1>Checkout</h1>
    <div class="grid" style="grid-template-columns: 1.4fr 1fr">
      <div>
        <div class="card">
          <div class="p">
            <h2>Datos de envio</h2>
            <form id="shipForm" class="form" style="display:grid; gap:.5rem">
              <label>Nombre completo<input id="fName" required /></label>
              <label>Correo<input id="fEmail" type="email" required /></label>
              <label>Telefono<input id="fPhone" required /></label>
              <label>Direccion<input id="fAddr" required /></label>
              <label>Ciudad<input id="fCity" required /></label>
            </form>
          </div>
        </div>

        <div class="card" style="margin-top:1rem">
          <div class="p">
            <h2>Metodo de pago</h2>
            <div style="display:grid; gap:.5rem">
              <p class="muted">Métodos de pago próximamente</p>
            </div>
            <button class="btn" id="payBtn" style="margin-top:.75rem" disabled
              >Pagar ahora</button
            >
            <div
              id="payError"
              class="muted"
              style="color:#b91c1c; display:none; margin-top:.35rem"
            >
            </div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <div class="p">
            <h2>Resumen</h2>
            <div id="sumList"></div>
            <div
              style="display:flex; justify-content:space-between; margin-top:.5rem"
            >
              <span>Total</span>
              <strong id="sumTotal">$0</strong>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <script>
    // flujo de checkout: próximamente
    (function () {
      function $(s, r = document) {
        return r.querySelector(s);
      }
      function fmt(n) {
        return "$" + Number(n || 0).toLocaleString("es-CO");
      }
      function ready(fn) {
        if (document.readyState !== "loading") fn();
        else document.addEventListener("DOMContentLoaded", fn);
      }
      function whenCart(fn) {
        if (window.Cart) fn();
        else setTimeout(() => whenCart(fn), 30);
      }

      ready(() =>
        whenCart(function () {
          const sumList = $("#sumList");
          const sumTotal = $("#sumTotal");
          const payBtn = document.getElementById("payBtn");
          const payError = document.getElementById("payError");

          const cart = window.Cart.getCart();
          if (!cart.length) {
            sumList.innerHTML = '<p class="muted">Tu carrito esta vacio.</p>';
            sumTotal.textContent = fmt(0);
            if (payBtn) {
              payBtn.disabled = true;
              payBtn.textContent = "Carrito vacio";
            }
            return;
          }
          sumList.innerHTML = cart
            .map(
              (p) =>
                `<div style="display:flex; justify-content:space-between; gap:.5rem"><span>${p.qty}× ${p.name || ""}</span><span>${fmt((p.price || 0) * p.qty)}</span></div>`
            )
            .join("");
          const total = window.Cart.subtotal();
          sumTotal.textContent = fmt(total);

          async function pay() {
            payError.textContent = "Los métodos de pago aún no están disponibles";
            payError.style.display = "block";
          }
          payBtn.addEventListener("click", pay);
        })
      );
    })();
  </script>
</Layout>

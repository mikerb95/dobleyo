---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin · DobleYo" isAdmin={true} />
    <meta name="robots" content="noindex, nofollow" />
  </head>
  <body class="font-sans bg-cream text-ink" style="visibility: hidden;">
    <!-- Barra superior de anuncio -->
    <div class="topbar" id="topbar">
      <div class="container">
        <span
          >Novedad: Envíos nacionales gratis desde $120.000 · Nuevas cosechas
          Huila & Nariño</span
        >
        <button class="topbar-close" aria-label="Cerrar" id="topbarClose"
          >×</button
        >
      </div>
    </div>
    <!-- Animación de transición de página -->
    <div class="transition-overlay" id="transitionOverlay" aria-hidden="true">
    </div>
    <Header />
    <main class="container">
      <slot />
    </main>
    <Footer />
    <script>
      // Verificar autenticación y rol (caficultor o admin)
      (async function () {
        const token = localStorage.getItem("adminToken");
        const currentPath = window.location.pathname;

        console.log("[AppLayout] Verificando autenticación...", { token: token ? "presente" : "ausente" });

        if (!token) {
          console.log("[AppLayout] No hay token, redirigiendo a login");
          window.location.href =
            "/login?redirect=" + encodeURIComponent(currentPath);
          return;
        }

        try {
          const response = await fetch("/api/auth/me", {
            headers: { Authorization: `Bearer ${token}` },
            credentials: "include",
          });

          console.log("[AppLayout] Respuesta /api/auth/me:", response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("[AppLayout] Error en /api/auth/me:", errorText);
            localStorage.removeItem("adminToken");
            window.location.href =
              "/login?redirect=" + encodeURIComponent(currentPath);
            return;
          }

          const user = await response.json();
          console.log("[AppLayout] Usuario autenticado:", user);

          // Verificar que sea caficultor o admin
          if (user.role !== "caficultor" && user.role !== "admin") {
            alert(
              "Acceso denegado. Esta app es solo para caficultores y administradores."
            );
            window.location.href = "/";
            return;
          }

          // Guardar rol en variable global para uso posterior
          window.userRole = user.role;
          window.userName = user.name;

          // Usuario autenticado correctamente, mostrar contenido
          document.body.style.visibility = "visible";
          console.log("[AppLayout] Contenido visible");
        } catch (error) {
          console.error("[AppLayout] Error de red o parsing:", error);
          localStorage.removeItem("adminToken");
          window.location.href =
            "/login?redirect=" + encodeURIComponent(currentPath);
        }
      })();

      document.getElementById("topbarClose")?.addEventListener("click", () => {
        document.getElementById("topbar")!.style.display = "none";
      });
    </script>
  </body>
</html>

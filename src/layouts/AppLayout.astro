---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin · DobleYo" isAdmin={true} />
    <meta name="robots" content="noindex, nofollow" />
  </head>
  <body class="font-sans bg-cream text-ink" style="visibility: hidden;">
    <!-- Barra superior de anuncio -->
    <div class="topbar" id="topbar">
      <div class="container">
        <span
          >Novedad: Envíos nacionales gratis desde $120.000 · Nuevas cosechas
          Huila & Nariño</span
        >
        <button class="topbar-close" aria-label="Cerrar" id="topbarClose"
          >×</button
        >
      </div>
    </div>
    <!-- Animación de transición de página -->
    <div class="transition-overlay" id="transitionOverlay" aria-hidden="true">
    </div>
    <Header />
    <main class="container">
      <slot />
    </main>
    <Footer />
    <script is:inline src="/assets/js/auth-refresh.js"></script>
    <script>
      // Verificar autenticación y rol (caficultor o admin)
      (async function () {
        const token = localStorage.getItem("adminToken");
        const currentPath = window.location.pathname;

        console.log("[AppLayout] Verificando autenticación...", {
          token: token ? "presente" : "ausente",
        });

        if (!token) {
          console.log("[AppLayout] No hay token, redirigiendo a login");
          window.location.href =
            "/login?redirect=" + encodeURIComponent(currentPath);
          return;
        }

        try {
          console.log("[AppLayout] Haciendo fetch a /api/auth/me...");
          
          const response = await fetch("/api/auth/me", {
            method: "GET",
            credentials: "include", // Solo usar cookies, sin Authorization header
          });

          console.log("[AppLayout] Respuesta /api/auth/me:", response.status, response.statusText);

          if (!response.ok) {
            const errorText = await response.text();
            console.error(
              "[AppLayout] Error en /api/auth/me:",
              response.status,
              errorText
            );

            // Solo redirigir a login si es error de autenticación (401/403)
            if (response.status === 401 || response.status === 403) {
              localStorage.removeItem("adminToken");
              localStorage.removeItem("userName");
              window.location.href =
                "/login?redirect=" + encodeURIComponent(currentPath);
              return;
            }

            // Error del servidor (500, etc) - mostrar mensaje pero no cerrar sesión
            document.body.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;">
                <h1 style="color:#d32f2f;margin-bottom:1rem;">Error del Servidor</h1>
                <p style="color:#666;margin-bottom:2rem;">No se pudo conectar con el servidor. Intenta de nuevo.</p>
                <p style="color:#999;font-size:0.9rem;margin-bottom:1rem;">Error: ${response.status}</p>
                <button onclick="location.reload()" style="padding:0.75rem 2rem;background:#4a6741;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">
                  Reintentar
                </button>
                <a href="/" style="margin-top:1rem;color:#4a6741;">Volver al inicio</a>
              </div>
            `;
            document.body.style.visibility = "visible";
            return;
          }

          const user = await response.json();
          console.log("[AppLayout] Usuario autenticado:", user);

          // Verificar que sea caficultor o admin
          if (user.role !== "caficultor" && user.role !== "admin") {
            alert(
              "Acceso denegado. Esta app es solo para caficultores y administradores."
            );
            window.location.href = "/";
            return;
          }

          // Guardar rol en variable global para uso posterior
          window.userRole = user.role;
          window.userName = user.name;

          // Usuario autenticado correctamente, mostrar contenido
          document.body.style.visibility = "visible";
          console.log("[AppLayout] Contenido visible");
        } catch (error) {
          console.error("[AppLayout] Error de red o parsing:", error);
          console.error("[AppLayout] Error stack:", error.stack);
          console.error("[AppLayout] Error type:", error.constructor.name);
          
          // Error de red - mostrar mensaje amigable, no cerrar sesión
          document.body.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;">
              <h1 style="color:#d32f2f;margin-bottom:1rem;">Error de Conexión</h1>
              <p style="color:#666;margin-bottom:2rem;">No se pudo conectar con el servidor. Verifica tu conexión a internet.</p>
              <pre style="color:#999;font-size:0.9rem;margin-bottom:1rem;max-width:600px;overflow:auto;background:#f5f5f5;padding:1rem;border-radius:4px;">${error.message}\n\nType: ${error.constructor.name}</pre>
              <button onclick="location.reload()" style="padding:0.75rem 2rem;background:#4a6741;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">
                Reintentar
              </button>
              <a href="/" style="margin-top:1rem;color:#4a6741;">Volver al inicio</a>
            </div>
          `;
          document.body.style.visibility = "visible";
        }
      })();

      document.getElementById("topbarClose")?.addEventListener("click", () => {
        document.getElementById("topbar")!.style.display = "none";
      });
    </script>
  </body>
</html>

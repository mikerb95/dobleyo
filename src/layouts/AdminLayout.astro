---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
import Analytics from "@vercel/analytics/astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin - DobleYo" isAdmin={true} />
    <Analytics />
  </head>
  <body class="font-sans bg-cream text-ink" style="visibility: hidden;">
    <Header />

    <main>
      <slot />
    </main>

    <Footer />

    <script is:inline src="/assets/js/auth-refresh.js"></script>

    <script>
      // Verificar autenticación de admin
      (async function () {
        const token = localStorage.getItem("adminToken");
        const currentPath = window.location.pathname;

        if (!token) {
          window.location.href =
            "/login?redirect=" + encodeURIComponent(currentPath);
          return;
        }

        try {
          const response = await fetch("/api/auth/me", {
            headers: { Authorization: `Bearer ${token}` },
            credentials: "include",
          });

          if (!response.ok) {
            localStorage.removeItem("adminToken");
            localStorage.removeItem("userName");
            window.location.href =
              "/login?redirect=" + encodeURIComponent(currentPath);
            return;
          }

          const user = await response.json();

          if (user.role !== "admin") {
            localStorage.removeItem("adminToken");
            localStorage.removeItem("userName");
            alert("Acceso denegado. Solo administradores pueden acceder.");
            window.location.href = "/";
            return;
          }

          // Usuario autenticado correctamente, mostrar contenido
          document.body.style.visibility = "visible";
        } catch (error) {
          localStorage.removeItem("adminToken");
          localStorage.removeItem("userName");
          window.location.href =
            "/login?redirect=" + encodeURIComponent(currentPath);
        }
      })();

      // Utilidades de métricas para el header sticky
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const setHeaderMetrics = () => {
          const headerCont = document.querySelector(".site-header .container");
          // @ts-ignore
          const hh = headerCont ? headerCont.offsetHeight : 96;
          // Sin topbar en admin, top es 0
          const top = 0;
          const pageOffset = top + hh + 12;
          const root = document.documentElement;
          root.style.setProperty("--header-top", top + "px");
          root.style.setProperty("--header-height", hh + "px");
          root.style.setProperty("--page-offset-top", pageOffset + "px");
        };
        setHeaderMetrics();
        window.addEventListener("resize", setHeaderMetrics);
      })();
    </script>
  </body>
</html>

---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin Panel - DobleYo" isAdmin={true} />
  </head>
  <body class="bg-gray-50 text-gray-900">
    <!-- Header -->
    <Header />

    <div id="app-container" class="min-h-screen flex hidden pt-32">
      <!-- Sidebar -->
      <aside
        class="w-64 bg-white border-r border-gray-200 flex-shrink-0 fixed h-full left-0 top-32 z-10"
      >
        <div class="p-6 border-b border-gray-200 flex items-center gap-3">
          <div
            class="w-8 h-8 bg-amber-900 rounded-lg flex items-center justify-center text-white font-bold"
          >
            D
          </div>
          <h1 class="text-xl font-bold text-gray-800">DobleYo Admin</h1>
        </div>

        <nav class="p-4 space-y-1">
          <a
            href="/admin"
            class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-amber-900 rounded-lg transition-colors group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              ></path>
            </svg>
            <span class="font-medium">Dashboard</span>
          </a>
          <a
            href="/admin/inventario"
            class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-amber-900 rounded-lg transition-colors group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
              ></path>
            </svg>
            <span class="font-medium">Inventario</span>
          </a>
          <a
            href="/admin/productos"
            class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-amber-900 rounded-lg transition-colors group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              ></path>
            </svg>
            <span class="font-medium">Productos</span>
          </a>
          <a
            href="/admin/lotes"
            class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-amber-900 rounded-lg transition-colors group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
              ></path>
            </svg>
            <span class="font-medium">Lotes de Café</span>
          </a>
        </nav>

        <div
          class="absolute bottom-0 left-0 w-full p-4 border-t border-gray-200 bg-gray-50"
        >
          <div class="flex items-center gap-3 mb-4 px-2">
            <div
              class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-800 font-bold text-sm"
            >
              A
            </div>
            <div class="text-sm overflow-hidden">
              <p class="font-medium text-gray-700 truncate" id="adminName">
                Cargando...
              </p>
              <p class="text-xs text-gray-500 truncate" id="adminEmail">...</p>
            </div>
          </div>
          <button
            id="logoutBtn"
            class="w-full px-4 py-2 text-sm font-medium text-red-600 bg-white border border-red-100 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              ></path>
            </svg>
            Cerrar Sesión
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 ml-64 p-8 w-full">
        <div class="max-w-6xl mx-auto">
          <slot />
        </div>
      </main>
    </div>

    <!-- Loading State -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white flex items-center justify-center z-50"
    >
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-900 mx-auto mb-4"
        >
        </div>
        <p class="text-gray-600 font-medium">Verificando permisos...</p>
      </div>
    </div>

    <script>
      // Auth Check
      (async function () {
        try {
          const res = await fetch("/api/auth/me", { credentials: "include" });
          if (!res.ok) throw new Error("Unauthorized");

          const user = await res.json();
          if (user.role !== "admin") {
            alert("Acceso denegado: Se requieren permisos de administrador.");
            window.location.href = "/";
            return;
          }

          // Update UI
          const nameEl = document.getElementById("adminName");
          const emailEl = document.getElementById("adminEmail");
          if (nameEl) nameEl.textContent = user.name || "Admin";
          if (emailEl) emailEl.textContent = user.email;

          // Show App
          document.getElementById("loading-screen").style.display = "none";
          document.getElementById("app-container").classList.remove("hidden");

          // Highlight current page
          const currentPath = window.location.pathname;
          const links = document.querySelectorAll("nav a");
          links.forEach((link) => {
            if (link.getAttribute("href") === currentPath) {
              link.classList.add("bg-amber-50", "text-amber-900");
              link.classList.remove("text-gray-600", "hover:bg-gray-50");
            }
          });
        } catch (err) {
          window.location.href = "/login?redirect=" + window.location.pathname;
        }
      })();

      // Logout
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await fetch("/api/auth/logout", {
              method: "POST",
              credentials: "include",
            });
            window.location.href = "/login";
          } catch (err) {
            console.error("Logout failed", err);
          }
        });
      }
    </script>

    <!-- Footer -->
    <Footer />
  </body>
</html>

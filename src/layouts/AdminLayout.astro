---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin - DobleYo" isAdmin={true} />
  </head>
  <body class="bg-gray-50">
    <Header />
    
    <div class="flex min-h-screen pt-32">
      <!-- Sidebar -->
      <aside class="w-56 bg-white border-r border-gray-200 fixed h-full left-0 top-32 overflow-y-auto">
        <nav class="p-4 space-y-1">
          <a href="/admin" class="block px-4 py-3 rounded text-gray-700 hover:bg-gray-100">Dashboard</a>
          <a href="/admin/inventario" class="block px-4 py-3 rounded text-gray-700 hover:bg-gray-100">Inventario</a>
          <a href="/admin/productos" class="block px-4 py-3 rounded text-gray-700 hover:bg-gray-100">Productos</a>
          <a href="/admin/lotes" class="block px-4 py-3 rounded text-gray-700 hover:bg-gray-100">Lotes</a>
        </nav>
        <div class="p-4 border-t border-gray-200 mt-4">
          <p class="text-sm text-gray-700 mb-3" id="adminName">Admin</p>
          <button id="logoutBtn" class="w-full px-3 py-2 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
            Cerrar
          </button>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1 ml-56 p-6">
        <slot />
      </main>
    </div>

    <Footer />

    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
      <p>Verificando...</p>
    </div>

    <script>
      (async function () {
        try {
          const res = await fetch("/api/auth/me", { credentials: "include" });
          if (!res.ok) throw new Error("Unauthorized");

          const user = await res.json();
          if (user.role !== "admin") {
            window.location.href = "/";
            return;
          }

          document.getElementById("adminName").textContent = user.name || "Admin";
          document.getElementById("loading-screen").style.display = "none";
        } catch (err) {
          window.location.href = "/login?redirect=" + window.location.pathname;
        }
      })();

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
        window.location.href = "/login";
      });
    </script>
  </body>
</html>
  </body>
</html>

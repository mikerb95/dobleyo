---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Head from "../components/Head.astro";
---

<!doctype html>
<html lang="es">
  <head>
    <Head title="Admin Panel - DobleYo" isAdmin={true} />
  </head>
  <body class="bg-gray-50 text-gray-900">
    <!-- Header -->
    <Header />

    <div class="flex min-h-screen pt-32">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r border-gray-200 fixed h-screen left-0 top-32 overflow-y-auto">
        <!-- Sidebar Header -->
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-900 rounded-lg flex items-center justify-center text-white font-bold text-lg">
              D
            </div>
            <div>
              <h2 class="font-bold text-gray-900">DobleYo</h2>
              <p class="text-xs text-gray-500">Admin</p>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="p-4 space-y-2">
          <a
            href="/admin"
            class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors group"
            id="nav-dashboard"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 group-hover:text-amber-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            <span class="font-medium text-sm">Dashboard</span>
          </a>

          <a
            href="/admin/inventario"
            class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors group"
            id="nav-inventario"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 group-hover:text-amber-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <span class="font-medium text-sm">Inventario</span>
          </a>

          <a
            href="/admin/productos"
            class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors group"
            id="nav-productos"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 group-hover:text-amber-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span class="font-medium text-sm">Productos</span>
          </a>

          <a
            href="/admin/lotes"
            class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors group"
            id="nav-lotes"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 group-hover:text-amber-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <span class="font-medium text-sm">Lotes de Caf√©</span>
          </a>
        </nav>

        <!-- User Section -->
        <div class="absolute bottom-0 left-0 w-full p-4 border-t border-gray-200 bg-white">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center text-amber-800 font-bold text-sm">
              A
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate" id="adminName">Admin</p>
              <p class="text-xs text-gray-500 truncate" id="adminEmail">admin@dobleyo.cafe</p>
            </div>
          </div>
          <button
            id="logoutBtn"
            class="w-full px-3 py-2 text-xs font-medium text-red-600 bg-red-50 border border-red-200 hover:bg-red-100 rounded-lg transition-colors flex items-center justify-center gap-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Cerrar
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 ml-64 p-6">
        <div class="max-w-6xl mx-auto">
          <slot />
        </div>
      </main>
    </div>

    <!-- Loading State -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-900 mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">Verificando acceso...</p>
      </div>
    </div>

    <script>
      // Auth Check
      (async function () {
        try {
          const res = await fetch("/api/auth/me", { credentials: "include" });
          if (!res.ok) throw new Error("Unauthorized");

          const user = await res.json();
          if (user.role !== "admin") {
            alert("Acceso denegado: Se requieren permisos de administrador.");
            window.location.href = "/";
            return;
          }

          // Update user info
          const nameEl = document.getElementById("adminName");
          const emailEl = document.getElementById("adminEmail");
          if (nameEl) nameEl.textContent = user.name || "Admin";
          if (emailEl) emailEl.textContent = user.email;

          // Hide loading
          document.getElementById("loading-screen").style.display = "none";

          // Highlight current nav item
          const currentPath = window.location.pathname;
          const navItems = document.querySelectorAll("nav a");
          navItems.forEach((link) => {
            if (link.getAttribute("href") === currentPath) {
              link.classList.remove("text-gray-700", "hover:bg-gray-100");
              link.classList.add("bg-amber-50", "text-amber-900");
              link.querySelector("svg").classList.add("text-amber-900");
            }
          });
        } catch (err) {
          window.location.href = "/login?redirect=" + window.location.pathname;
        }
      })();

      // Logout
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await fetch("/api/auth/logout", {
              method: "POST",
              credentials: "include",
            });
            window.location.href = "/login";
          } catch (err) {
            console.error("Logout failed", err);
          }
        });
      }
    </script>

    <!-- Footer -->
    <Footer />
  </body>
</html>

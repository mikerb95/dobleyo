<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout Â· DobleYo</title>
  <link rel="icon" href="assets/logo.svg" type="image/svg+xml">
  <meta name="theme-color" content="#251a14">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="font-sans bg-cream text-ink">
  <header class="site-header" id="siteHeader">
    <div class="container">
  <a class="brand" href="index.html" data-link><img src="assets/logo.png" alt="DobleYo" height="56"/></a>
      <nav class="nav">
        <a href="index.html" data-link>Inicio</a>
        <a href="tienda.html" data-link>Tienda</a>
        <!-- 'Mi cuenta' removed from navbar per request -->
      </nav>
      <div class="actions">
        <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema" title="Cambiar tema">ðŸŒ™</button>
        <a href="login.html" class="icon-btn user-btn" aria-label="Iniciar sesiÃ³n" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z" fill="currentColor"/></svg>
        </a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: calc(var(--header-height, 96px) + 28px)">
    <section>
      <h1>Checkout</h1>
      <div class="grid" style="grid-template-columns: 1.4fr 1fr">
        <div>
          <div class="card"><div class="p">
            <h2>Datos de envio</h2>
            <form id="shipForm" class="form" style="display:grid; gap:.5rem">
              <label>Nombre completo<input id="fName" required></label>
              <label>Correo<input id="fEmail" type="email" required></label>
              <label>Telefono<input id="fPhone" required></label>
              <label>Direccion<input id="fAddr" required></label>
              <label>Ciudad<input id="fCity" required></label>
            </form>
          </div></div>

          <div class="card" style="margin-top:1rem"><div class="p">
            <h2>Metodo de pago</h2>
            <div style="display:grid; gap:.5rem">
              <label><input type="radio" name="pay" value="mp" checked> Mercado Pago</label>
              <label><input type="radio" name="pay" value="wompi"> Wompi</label>
            </div>
            <button class="btn" id="payBtn" style="margin-top:.75rem">Pagar ahora</button>
            <div id="payError" class="muted" style="color:#b91c1c; display:none; margin-top:.35rem"></div>
          </div></div>
        </div>

        <aside>
          <div class="card"><div class="p">
            <h2>Resumen</h2>
            <div id="sumList"></div>
            <div style="display:flex; justify-content:space-between; margin-top:.5rem">
              <span>Total</span>
              <strong id="sumTotal">$0</strong>
            </div>
          </div></div>
        </aside>
      </div>
    </section>
  </main>

  <script src="assets/js/app.js" defer></script>
  <script src="assets/js/cart.js" defer></script>
  <script>
    // flujo de checkout: manda pedido al backend para crear preferencia (MP) o firma (Wompi)
    (function(){
      function $(s, r=document){ return r.querySelector(s); }
      function fmt(n){ return '$'+Number(n||0).toLocaleString('es-CO'); }
      function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      function whenCart(fn){ if (window.Cart) fn(); else setTimeout(()=>whenCart(fn), 30); }

      ready(()=> whenCart(function(){
        const sumList = $('#sumList');
        const sumTotal = $('#sumTotal');
        const payBtn = document.getElementById('payBtn');
        const payError = document.getElementById('payError');

        const cart = window.Cart.getCart();
        if (!cart.length){
          sumList.innerHTML = '<p class="muted">Tu carrito esta vacio.</p>';
          sumTotal.textContent = fmt(0);
          if (payBtn) { payBtn.disabled = true; payBtn.textContent = 'Carrito vacio'; }
          return;
        }
        sumList.innerHTML = cart.map(p=> `<div style="display:flex; justify-content:space-between; gap:.5rem"><span>${p.qty}Ã— ${(p.name||'')}</span><span>${fmt((p.price||0)*p.qty)}</span></div>`).join('');
        const total = window.Cart.subtotal();
        sumTotal.textContent = fmt(total);

        async function pay(){
          payError.style.display = 'none';
          const payMethod = document.querySelector('input[name="pay"]:checked')?.value || 'mp';
          const order = {
            items: cart.map(p=>({ id:p.id, title:p.name, quantity:p.qty, unit_price:p.price })),
            total,
            shipping: {
              name: $('#fName').value, email: $('#fEmail').value, phone: $('#fPhone').value,
              address: $('#fAddr').value, city: $('#fCity').value
            },
            reference: 'DBYO-'+Date.now()
          };
          try{
            if (payMethod === 'mp'){
              const res = await fetch('/api/mp/create_preference', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order) });
              const data = await res.json();
              if(!res.ok) throw new Error(data.error||'Error creando preferencia');
              // redirigir a init_point
              location.href = data.init_point;
            } else {
              const res = await fetch('/api/wompi/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order) });
              const data = await res.json();
              if(!res.ok) throw new Error(data.error||'Error generando checkout');
              // redirigir a la URL de wompi
              location.href = data.checkout_url;
            }
          } catch (e){
            payError.textContent = e.message;
            payError.style.display='block';
          }
        }
        payBtn.addEventListener('click', pay);
      }));
    })();
  </script>
</body>
</html>
